# 作者
QQ群：**852283276**
微信：**arm80x86**
微信公众号：**青儿创客基地**
B站：[主页 `https://space.bilibili.com/208826118`](https://space.bilibili.com/208826118)

# 货架示意图
货架最多有64个位置，最多8层，每层8位。根据现场情况如果不需要这么多位置，如图，假设变更为黄色虚线框内4层*4位的数量，帧里规定的位置地址继续沿用，其他未使用的位置数据为0xFFFF。
![这里写图片描述](https://img-blog.csdn.net/20180710114802445?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# 软件功能描述

1. 可录入物资名称位置和信息。可通过现场货架上摆放好的物资，手动录入到我们开发的软件中并存储，由第三方软件随时调用。如：一层一号位：万用表。货架数量不小于100个；
2. 可录入货架的规格。通过手动录入货架规格到软件，供第三方软件调用，知道货架为几层、每层几位；
3. 可录入货架每个位置的物资重量。手动将物资单个重量信息录入到软件，用来计算物资数量。
4. 物资入库时间。手动录入每个新物资的入库时间。
5. 物资试验周期。手动录入每个物资的试验周期，供第三方软件调用提示用户定期试验。

# 数据结构设计

货架规格，
| 货架ID | 层数 | 每层货架位数 |
|:-------------:|:-------------:|:-------------:|
| 1 | 4 | 4 |
| 2 | 8 | 8 | 
物资表，这里如果存在两个不同品牌的万用表，使用万用表A和万用表B命名，当成两个不同的货物，
| 物资ID | 物资名称 | 物资单个重量 | 
| ------------- |:-------------:|:-------------:|
| 0 | 万用表 | 500g |
| 1 | 示波器 | 5000g | 
| 2 | 镊子 | 5g |
货物信息，
| 货架ID | 层数 | 位数 | 物资ID | 入库时间 | 试验周期 | 货物总重量 | 货物数量 |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| 3 | 1 | 3 | 0 | 2018-07-10 11:17:54 | 1天 | 50000g | 32 |
| 6 | 2 | 2 | 1 | 2018-07-10 11:17:54 | 1天 | 45000g | 10 |
| 8 | 3 | 2 | 2 | 2018-07-10 11:17:54 | 1天 | 80000g | 68 |
事件，
| 货架ID | 层数 | 位数 | 物资ID | 时间 | 取（负）放（正） | 
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| 3 | 1 | 2 | 0 | 2018-07-10 11:17:54 | -1 |
| 6 | 2 | 3 | 1 | 2018-07-10 11:17:54 | 4 |
| 8 | 6 | 1 | 2 | 2018-07-10 11:17:54 | 6 |

# 单片机协议

重力货架采用RS-485  Modbus RTU协议上传数据，每一帧包含：

1. 货架ID信息：设备ID地址1-256，共1Byte；
2. 实时时间信息：年（2Byte）月（1Byte）日（1Byte）时（1Byte）分（1Byte）秒（1Byte），共7Byte；
3. 重力参数：货架每个位置上传1个重力参数。单位为：克；每个位置参数为2Byte，共64*2Byte；
4. CRC校验；

每一帧的组成：ID（1B）+Time（7B）+重力参数64个位置（128B）+CRC

# 外部调用的API接口

采用Websocket + Jsonrpc提供服务，

1. 货架在某个位置的物资名称信息，第三方软件可得知：XX时间、XX货架的XX位置，物资名称为XX；
2. 货架上某个位置的物资数量信息。第三方软件可得知：XX时间、XX货架的XX位置，物资数量为XX个；
根据物资底层数据帧信息。将实时帧内的每个位置的重量信息除以录入的物资重量得到当前的物资数量（结果四舍五入）；
3. 事件信息。事件包括：XX时间、XX货架的XX位置，取/放XX个XX物资。重量增加判断为放、重量减少判断为取。
4. 报警信息（暂时不做）。对于单个位置只放置单个物资，当实际上传的数据超过录入的物资重量±5%，输出错位信号，XX时间、XX货架的XX位置物资放置错误。

# UI设计

设计4个界面，货架视图，
![这里写图片描述](https://img-blog.csdn.net/20180716230254619?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
物资视图，
![这里写图片描述](https://img-blog.csdn.net/20180716230318694?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
货物视图，
![这里写图片描述](https://img-blog.csdn.net/20180716230408997?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
事件视图，
![这里写图片描述](https://img-blog.csdn.net/2018071623050229?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

