# 作者
QQ群：**852283276**
微信：**arm80x86**
微信公众号：**青儿创客基地**
B站：[主页 `https://space.bilibili.com/208826118`](https://space.bilibili.com/208826118)

# VCU
## BSP
```bash
$ source /opt/Xilinx/Petalinux/2019.1/settings.sh
$ explorer.exe .
$ mkdir project
$ cd project/
$ mkdir petalinux
$ petalinux-create -t project -s /mnt/e/project/rdf0428-zcu106-vcu-trd-2019-1_v2/apu/vcu_petalinux_bsp/xilinx-vcu-trd-zcu106-v2019.1-final.bsp
$ petalinux-config --get-hw-description=/mnt/e/project/zynqmp_vcu/zynqmp_vcu.sdk
$ petalinux-config -c rootfs
$ petalinux-build
$ petalinux-package --boot --fpga /mnt/e/project/zynqmp_vcu/zynqmp_vcu.runs/impl_1/system_wrapper.bit --u-boot --force
$ sudo mount -t drvfs F: /mnt/zcu104/
$ cp images/linux/BOOT.BIN /mnt/zcu104/
$ cp images/linux/image.ub /mnt/zcu104/
$ sudo umount /mnt/zcu104/
# sudo mount -t drvfs F: /mnt/zcu104/ && cp images/linux/BOOT.BIN /mnt/zcu104/ && cp images/linux/image.ub /mnt/zcu104/ && sudo umount /mnt/zcu104/
# 设置bitstream压缩后，只有7.48 MB (7,852,461 字节)，之前是18.4 MB (19,311,211 字节)
# u-boot下网络更新sd中的boot和kernel
$ cp images/linux/BOOT.BIN /mnt/e/project/zynqmp_vcu/ && cp images/linux/image.ub /mnt/e/project/zynqmp_vcu/
ZynqMP> setenv serverip 192.168.6.6
ZynqMP> run update_boot && run update_kernel
root@zynqmp_vcu:~# ls -l /dev/dri/by-path/
lrwxrwxrwx    1 root     root             8 Aug  3 03:48 platform-fd4a0000.zynqmp-display-card -> ../card0
root@zynqmp_vcu:~# ls -l /dev/v4l/by-path/                                           
lrwxrwxrwx    1 root     root            12 Aug  3 03:48 platform-amba_pl@0:vcap_tp0-video-index0 -> ../../video0
# 下载文件到fat32，linux总是只读，利用u-boot下载到tf卡中，
$ tftpboot ${clobstart} VID_20200427_184617.yuv
$ mmcinfo && fatwrite mmc ${sdbootdev} ${clobstart} VID_20200427_184617.yuv ${filesize}
```

## DP测试
```bash
# 彩条
$ modetest -D fd4a0000.zynqmp-display -s 39:1920x1080-60@AR24 &
# 彩条
$ gst-launch-1.0 videotestsrc ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
# 雪花
$ gst-launch-1.0 videotestsrc pattern=1 ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
# 播放视频，视频源是30Hz，使用videorate强制转换到60Hz，视频有重影
gst-launch-1.0 filesrc location="/run/media/mmcblk0p1/VID_20200427_184617.mp4" ! qtdemux ! h264parse ! omxh264dec ! queue ! videorate ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
```

## VCU测试
```bash
# vcu-ctrl-sw
$ sudo apt install subversion
# 通过详细打印定位错误，修改Makefile
$ make V=1
$ vim Makefile
# Cross build support
CROSS_COMPILE?=
# CXX:=$(CROSS_COMPILE)g++
CXX:=$(CROSS_COMPILE)g++ --sysroot=$(SDKTARGETSYSROOT)
# CC:=$(CROSS_COMPILE)gcc
CC:=$(CROSS_COMPILE)gcc --sysroot=$(SDKTARGETSYSROOT)
AS:=$(CROSS_COMPILE)as
AR:=$(CROSS_COMPILE)ar
NM:=$(CROSS_COMPILE)nm
# LD:=$(CROSS_COMPILE)ld
LD:=$(CROSS_COMPILE)ld --sysroot=$(SDKTARGETSYSROOT)
OBJDUMP:=$(CROSS_COMPILE)objdump
OBJCOPY:=$(CROSS_COMPILE)objcopy
RANLIB:=$(CROSS_COMPILE)ranlib
STRIP:=$(CROSS_COMPILE)strip
SIZE:=$(CROSS_COMPILE)size
$ cp /run/media/mmcblk0p1/ctrlsw_* .
$ cp /run/media/mmcblk0p1/encode_example.cfg .
$ cat encode_example.cfg
YUVFile = VID_20200427_184617.yuv
Width  = 1920
Height = 1080
FrameRate = 30
Loop = FALSE                                                                                                                                                
MaxPicture = ALL  
$ tftp -r ctrlsw_decoder -g 192.168.6.6
$ tftp -r ctrlsw_encoder -g 192.168.6.6  
$ tftp -r encode_example.cfg -g 192.168.6.6 
$ chmod +x ctrlsw_decoder 
$ chmod +x ctrlsw_encoder
$ tftp -r VID_20200427_184617.yuv -g 192.168.6.6
# 失败
$ ./ctrlsw_encoder -cfg encode_example.cfg
$ tftp -l a.mp4 -p 192.168.6.6
# h.264编解码
$ gst-launch-1.0 filesrc location=VID_20200427_184617.yuv ! videoparse format=nv12 width=1920 height=1080 framerate=30/1 ! omxh264enc ! queue ! h264parse ! mp4mux ! filesink location=g.mp4
$ gst-launch-1.0 filesrc location="/home/root/g.mp4" ! qtdemux ! h264parse ! omxh264dec ! queue ! videorate ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
# h.265编解码
$ gst-launch-1.0 filesrc location=g.mp4 ! qtdemux ! h265parse ! omxh265dec ! queue ! videorate ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
# 30秒
$ E:\ffmpeg-4.4-full_build\bin\ffmpeg.exe -i E:\project\tftp\VID_20200427_184617.mp4 -t 30 -s 1920x1080 -pix_fmt yuv420p E:\project\tftp\VID_20200427_184617.yuv
$ E:\ffmpeg-4.4-full_build\bin\ffmpeg -i E:\project\tftp\VID_20200427_184617.mp4 -t 3 -s 1920x1080 -pix_fmt nv12 E:\project\tftp\VID_20200427_184617.yuv
参数说明：-i：指定输入文件；-f：编码类型，与FFmpeg中的AVCodecID对应，取ID后的字符串，如AV_CODEC_ID_RAWVIDEO则为rawvideo，不区分大小写，如既可写-f rawvideo也可写-f RAWVIDEO；-pixel_format：像素格式，与FFmpeg中的AVPixelFormat对应，取FMT后的字符串，如AV_PIX_FMT_YUV420P则为yuv420p，必须全为小写；-video_size：帧大小，形式为宽x高，注意为”x”，而不是”*”。
$ ffplay -pix_fmts
$ E:\ffmpeg-4.4-full_build\bin\ffplay.exe -video_size 1920*1080 -pixel_format nv12 -framerate 30 -i E:\project\tftp\VID_20200427_184617.yuv
```

## TPG测试
```bash
root@zynqmp_vcu:~# media-ctl -d /dev/media0 -p
Media controller API version 4.19.0

Media device information
------------------------
driver          xilinx-video
model           Xilinx Video Composite Device
serial          
bus info        
hw revision     0x0
driver version  4.19.0

Device topology
- entity 1: vcap_tp0 output 0 (1 pad, 1 link)
            type Node subtype V4L flags 0
            device node name /dev/video0
        pad0: Sink
                <- "a0010000.v_tpg":0 [ENABLED]

- entity 5: a0010000.v_tpg (1 pad, 1 link)
            type V4L2 subdev subtype Unknown flags 0
            device node name /dev/v4l-subdev0
        pad0: Source
                [fmt:UYVY10_1X20/0x0@1/30 field:none colorspace:srgb]
                -> "vcap_tp0 output 0":0 [ENABLED]
root@zynqmp_vcu:~# yavta -l /dev/v4l-subdev0
Device /dev/v4l-subdev0 opened.
--- User Controls (class 0x00980001) ---
control 0x0098c903 `Test Pattern: Color Mask' min 0 max 7 step 0 default 0 current 0.
control 0x0098c907 `Test Pattern: Motion Speed' min 0 max 255 step 1 default 4 current 4.
control 0x0098c908 `Test Pattern: Cross Hairs Row' min 0 max 4095 step 1 default 100 current 100.
control 0x0098c909 `Test Pattern: Cross Hairs Colum' min 0 max 4095 step 1 default 100 current 100.
control 0x0098c90a `Test Pattern: Zplate Horizontal' min 0 max 65535 step 1 default 30 current 30.
control 0x0098c90b `Test Pattern: Zplate Horizontal' min 0 max 65535 step 1 default 0 current 0.
control 0x0098c90c `Test Pattern: Zplate Vertical S' min 0 max 65535 step 1 default 1 current 1.
control 0x0098c90d `Test Pattern: Zplate Vertical S' min 0 max 65535 step 1 default 0 current 0.
control 0x0098c90e `Test Pattern: Box Size' min 0 max 4095 step 1 default 50 current 50.
control 0x0098c90f `Test Pattern: Box Color(RGB/YCb' min 0 max 16777215 step 1 default 0 current 0.
control 0x0098c912 `Test Pattern: Foreground Patter' min 0 max 2 step 1 default 0 current 0.
  0: No Overlay (*)
  1: Moving Box
  2: Cross Hairs
control 0x0098c913 `Pixels per clock' min 1 max 2 step 1 default 1 current 1.
--- Image Source Controls (class 0x009e0001) ---
control 0x009e0901 `Vertical Blanking' min 3 max 8159 step 1 default 100 current 100.
control 0x009e0902 `Horizontal Blanking' min 3 max 8159 step 1 default 100 current 100.
--- Image Processing Controls (class 0x009f0001) ---
control 0x009f0903 `Test Pattern' min 0 max 16 step 1 default 9 current 9.
  1: Horizontal Ramp
  2: Vertical Ramp
  3: Temporal Ramp
  4: Solid Red
  5: Solid Green
  6: Solid Blue
  7: Solid Black
  8: Solid White
  9: Color Bars (*)
  10: Zone Plate
  11: Tartan Color Bars
  12: Cross Hatch
  13: Color Sweep
  14: Vertical/Horizontal Ramps
  15: Black/White Checker Board
  16: PseudoRandom
15 controls found.
Unable to get format: Inappropriate ioctl for device (25).
root@zynqmp_vcu:~# yavta -w '0x009f0903 13' /dev/v4l-subdev0
root@zynqmp_vcu:~# yavta --enum-formats /dev/video0
Device /dev/video0 opened.
Device `vcap_tp0 output 0' on `platform:vcap_tp0:0' is a video output (without mplanes) device.
- Available formats:
        Format 0: XV20 (30325658)
        Type: Video capture (1)
        Name: Y/CrCb 4:2:2 10-bit

        Format 1: XV20 (30325658)
        Type: Video capture (1)
        Name: Y/CrCb 4:2:2 10-bit

        Format 0: XM20 (30324d58)
        Type: Video capture mplanes (9)
        Name: Y/CrCb 4:2:2 10-bit (N-C)

        Format 1: XV20 (30325658)
        Type: Video capture mplanes (9)
        Name: Y/CrCb 4:2:2 10-bit

Video format: YUYV (56595559) 1920x0 field none, 0 planes: 
root@zynqmp_vcu:~# media-ctl -d /dev/media0 -V '"a0010000.v_tpg":0 [fmt:RBG888_1X24/1920x1080 field:none]'
# 更改source，sink的Available formats发生变化
root@zynqmp_vcu:~# yavta --enum-formats /dev/video0                                                       
Device /dev/video0 opened.
Device `vcap_tp0 output 0' on `platform:vcap_tp0:0' is a video output (without mplanes) device.
- Available formats:
        Format 0: BGR24 (33524742)
        Type: Video capture (1)
        Name: 24-bit BGR 8-8-8

        Format 0: RGB24 (33424752)
        Type: Video capture mplanes (9)
        Name: 24-bit RGB 8-8-8

Video format: YUYV (56595559) 1920x0 field none, 0 planes: 
# v4l2-ctl可改变Video format参数，gst-launch-1.0也会更改
root@zynqmp_vcu:~# v4l2-ctl -d /dev/video0 --set-fmt-video=width=1920,height=1080,pixelformat='NV12'
root@zynqmp_vcu:~# v4l2-ctl -d /dev/video0 --set-fmt-video=width=1920,height=1080,pixelformat='XV20'
# 不支持ARGB8888_1X32，设置后fmt变成默认的UYVY10_1X20/1920x1080@1/60，XV20(yavta --enum-formats /dev/video0 )
root@zynqmp_vcu:~# media-ctl -d /dev/media0 -V '"a0010000.v_tpg":0 [fmt:ARGB8888_1X32/1920x1080 field:none]'
root@zynqmp_vcu:~# gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw, width=1920, height=1080, framerate=30/1 ! queue ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
root@zynqmp_vcu:~# gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw, width=1920, height=1080, format=RGB, framerate=15/1 ! queue ! videorate ! video/x-raw,width=1920,height=1080,framerate=60/1 ! kmssink bus-id="fd4a0000.zynqmp-display" fullscreen-overlay=true sync=false
root@zynqmp_vcu:~# gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw, width=1920, height=1080, format=RGB, framerate=15/1 ! queue ! filesink location="/home/root/a.rgb"
$ E:\ffmpeg-4.4-full_build\bin\ffplay.exe -video_size 1920*1080 -pixel_format argb -framerate 15 -i E:\project\tftp\a.rgb
root@zynqmp_vcu:~# gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw, width=1920, height=1080, format=XV20, framerate=30/1 ! queue ! filesink location="/home/root/a.xv20"

$ gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw, width=1920, height=1080, format=XV20, framerate=30/1  ! omxh264enc ! queue ! h264parse ! mp4mux ! filesink location=g.mp4
# H.265 1080p 运行 Xilinx Low Latency PL DDR XV20 HDMI Video Capture and Display
$ gst-launch-1.0 v4l2src device=/dev/video0 io-mode=4 ! video/x-raw\(memory:XLNXLL\), width=1920, height=1080, format=NV16_10LE32, framerate=60/1 ! omxh265enc qp-mode=auto gop-mode=low-delay-p gop-length=60  b-frames=0 target-bitrate=20000 num-slices=8 control-rate=low-latency prefetch-buffer=TRUE low-bandwidth=false filler-data=0 cpb-size=1000 initial-delay=500 ! video/x-h265, alignment=nal ! queue max-size-buffers=0 ! rtph265pay ! udpsink host=192.168.25.89 port=5004 buffer-size=60000000 max-bitrate=120000000 max-lateness=-1 qos-dscp=60 async=false
```

# Printer
安装VS2005，编译源码时，在解决方案上右键，点击菜单中的生成解决方案即可。

# AX7350
找不到eth0，在petalinux 2018.2上给phy ksz9031打补丁，参考[AR# 71201 PetaLinux 2018.2 - Product Update Release Notes and Known Issues](https://www.xilinx.com/support/answers/71201.html)，linux对应的branch和tag，
```bash
Component	Git repo	Git Branches	Git Tags	Commit ID	Comments
Linux	git://github.com/Xilinx/linux-xlnx.git	xlnx_rebase_v4.14	xlnx_rebase_v4.14_2018.2	"ad4cd988ba86ab0fb306d57f244b7eaa6cce79a4" Linux Kernel rebase version 4.14
U-Boot	git://github.com/Xilinx/u-boot-xlnx.git	master	xilinx-v2018.2	"21812b5fd359d8756d619a15b49b6079ae3f9f36" U-boot Version v2018.01
```
下载源代码，切换到这个分支，参考[git切换到某个tag](https://blog.csdn.net/dinnerhowe/article/details/79082769)，更改源代码，
```bash
$ git clone https://github.com/Xilinx/linux-xlnx.git
$ git branch -a
* master
  remotes/origin/2017.1_video_ea
  remotes/origin/2017.2_video_ea
  remotes/origin/2017.3_video_ea
  remotes/origin/2017.4_video_ea
  remotes/origin/HEAD -> origin/master
  remotes/origin/master
  remotes/origin/petalinux-v12.12
  remotes/origin/petalinux-v2013.04
  remotes/origin/xilinx/versal
  remotes/origin/xlnx_3.14
  remotes/origin/xlnx_3.17
  remotes/origin/xlnx_3.8
  remotes/origin/xlnx_rebase_v4.14
  remotes/origin/xlnx_rebase_v4.19
  remotes/origin/xlnx_rebase_v4.9
  remotes/origin/xlnx_rebase_v5.4
  remotes/origin/zynq/cleanup
  remotes/origin/zynq/clk
  remotes/origin/zynq/defconfig
  remotes/origin/zynq/dt
  remotes/origin/zynq/fixes
  remotes/origin/zynq/soc
  remotes/origin/zynqmp/dt
  remotes/origin/zynqmp/soc
  remotes/origin/zynqmp/soc-next
$ git checkout -b xlnx_rebase_v4.14 xlnx_rebase_v4.14_2018.2
$ git branch -a
  master
* xlnx_rebase_v4.14
  remotes/origin/2017.1_video_ea
  remotes/origin/2017.2_video_ea
  remotes/origin/2017.3_video_ea
  remotes/origin/2017.4_video_ea
  remotes/origin/HEAD -> origin/master
  remotes/origin/master
  remotes/origin/petalinux-v12.12
  remotes/origin/petalinux-v2013.04
  remotes/origin/xilinx/versal
  remotes/origin/xlnx_3.14
  remotes/origin/xlnx_3.17
  remotes/origin/xlnx_3.8
  remotes/origin/xlnx_rebase_v4.14
  remotes/origin/xlnx_rebase_v4.19
  remotes/origin/xlnx_rebase_v4.9
  remotes/origin/xlnx_rebase_v5.4
  remotes/origin/zynq/cleanup
  remotes/origin/zynq/clk
  remotes/origin/zynq/defconfig
  remotes/origin/zynq/dt
  remotes/origin/zynq/fixes
  remotes/origin/zynq/soc
  remotes/origin/zynqmp/dt
  remotes/origin/zynqmp/soc
  remotes/origin/zynqmp/soc-next
$ gedit drivers/net/ethernet/cadence/macb_main.c
$ git diff drivers/net/ethernet/cadence/macb_main.c > macb.patch
$ cat macb.patch 
diff --git a/drivers/net/ethernet/cadence/macb_main.c b/drivers/net/ethernet/cadence/macb_main.c
old mode 100644
new mode 100755
index 2624fc2..0d74736
--- a/drivers/net/ethernet/cadence/macb_main.c
+++ b/drivers/net/ethernet/cadence/macb_main.c
@@ -3663,6 +3663,7 @@ static int macb_probe(struct platform_device *pdev)
 	struct macb *bp;
 	int err;
 
+	printk("*************************************\n");
 	regs = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	mem = devm_ioremap_resource(&pdev->dev, regs);
 	if (IS_ERR(mem))
$ cp macb.patch ~/project/zynq-v2018.2/project-spec/meta-user/recipes-kernel/linux/linux-xlnx
$ ls -l ~/project/zynq-v2018.2/project-spec/meta-user/recipes-kernel/linux/linux-xlnx
total 32
-rw-rw-r-- 1 developer developer  530 Apr 12 09:43 macb.patch
-rw-rw-r-- 1 developer developer 3245 Nov 26 18:32 user_2020-11-27-10-32-00.cfg
-rw-rw-r-- 1 developer developer  102 Nov 29 19:47 user_2020-11-30-11-47-00.cfg
-rw-rw-r-- 1 developer developer   41 Nov 30 04:11 user_2020-11-30-20-11-00.cfg
-rw-rw-r-- 1 developer developer  273 Dec  1 00:27 user_2020-12-01-16-26-00.cfg
-rw-rw-r-- 1 developer developer  119 Dec 14 03:12 user_2020-12-14-19-11-00.cfg
-rw-rw-r-- 1 developer developer   63 Jan 19 08:39 user_2021-01-19-08-39-00.cfg
-rw-rw-r-- 1 developer developer   20 Apr 11 07:48 user_2021-04-11-07-48-00.cfg
$ cat ~/project/zynq-v2018.2/project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend 
SRC_URI += "file://user_2020-11-27-10-32-00.cfg \
            file://user_2020-11-30-11-47-00.cfg \
            file://user_2020-11-30-20-11-00.cfg \
            file://user_2020-12-01-16-26-00.cfg \
            file://user_2020-12-14-19-11-00.cfg \
            file://user_2021-01-19-08-39-00.cfg \
            file://user_2021-04-11-07-48-00.cfg \
            "

FILESEXTRAPATHS_prepend := "${THISDIR}/${PN}:"

$ cat ~/project/zynq-v2018.2/project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend 
SRC_URI += "file://user_2020-11-27-10-32-00.cfg \
            file://user_2020-11-30-11-47-00.cfg \
            file://user_2020-11-30-20-11-00.cfg \
            file://user_2020-12-01-16-26-00.cfg \
            file://user_2020-12-14-19-11-00.cfg \
            file://user_2021-01-19-08-39-00.cfg \
            file://user_2021-04-11-07-48-00.cfg \
            "
SRC_URI += "file://macb.patch"

FILESEXTRAPATHS_prepend := "${THISDIR}/${PN}:"

```
定位到用户手册里写错了，phy地址是1，不是3，坑货！
```bash
$ udhcpc -ieth0
$ ping 192.168.2.127
```
命令，
```bash
$ petalinux-package --boot --fpga images/linux/system_wrapper.bit --u-boot --force
```
FSBL打patch，因为需要用fsbl初始化si5338，使用`git diff`命令无法给新建的文件打patch，先commit，
```bash
$ git log
commit ba2bac54b6efd87e3a7456ed5c6d17d5ba1de1f0
Author: Mr.bangbangbabe <qingermaker@sina.com>
Date:   Sat Apr 17 03:29:59 2021 -0700

    add si5338

commit 875dcc7a4dca47ccb18eda0182f3577e598f8917
Author: Siva Addepalli <sivaprasad.addepalli@xilinx.com>
Date:   Thu Apr 15 15:11:43 2021 +0530

    Published Doxygen documentation for drivers, sw_services and PDFs for libraries
    
    Signed-off-by: Siva Addepalli <sivaprasad.addepalli@xilinx.com>
$ git format-patch 875dcc7a4dca47ccb18eda0182f3577e598f8917
0001-add-si5338.patch
developer@ubuntu:~/project/xilinx/embeddedsw$ cat 0001-add-si5338.patch
$ cp 0001-add-si5338.patch ~/project/zynq-v2019.1/
$ cd ~/project/zynq-v2019.1/
$ mkdir -p project-spec/meta-user/recipes-bsp/fsbl/files
$ mv 0001-add-si5338.patch project-spec/meta-user/recipes-bsp/fsbl/files
$ gedit vim project-spec/meta-user/recipes-bsp/fsbl/fsbl_%.bbappend
$ cat project-spec/meta-user/recipes-bsp/fsbl/fsbl_%.bbappend
# Patch for FSBL
# Note: do_configure_prepend task section is required only for 2017.1 release
# Refer https://github.com/Xilinx/meta-xilinx-tools/blob/rel-v2017.2/classes/xsctbase.bbclass#L29-L35
  
do_configure_prepend() {
    if [ -d "${S}/patches" ]; then
       rm -rf ${S}/patches
    fi
  
    if [ -d "${S}/.pc" ]; then
       rm -rf ${S}/.pc
    fi
}
  
SRC_URI_append = " \
        file://0001-add-si5338.patch \
        "
  
FILESEXTRAPATHS_prepend := "${THISDIR}/files:"
  
#Add debug for FSBL(optional)
# XSCTH_BUILD_DEBUG = "1"
  
#Enable appropriate FSBL debug or compiler flags
# YAML_COMPILER_FLAGS_append = " -DXPS_BOARD_ZCU102"
  
# Note: This is not required if you are using Yocto
# CAUTION!: EXTERNALXSCTSRC and EXTERNALXSCTSRC_BUILD is required only for 2018.2 and below petalinux releases
# EXTERNALXSCTSRC = ""
# EXTERNALXSCTSRC_BUILD = ""
developer@ubuntu:~/project/zynq-v2019.1$ source /opt/Xilinx/Petalinux/2019.1/settings.sh $ petalinux-build -x mrproper
 
#Note: In v2018.1 PetaLinux release onwards "petalinux-build -x mrproper" command will remove <plnx-proj-root>/components/plnx_workspace directory
$ rm -rf <plnx-proj-root>/components/plnx_workspace
$ petalinux-build
```

# mwm1132
1. 盘的复位没有拉起，更新单片机解决。
2. 开始的时候，SSD接错位置，即当前FPGA PCIe没有接SSD，导致pcie读写寄存器卡死，这个在Z7上是不会的，只是报Link down。
3. AXI PCIe Class配置错误`Found P2CardBus bridge`，应该是`Found P2P bridge`，导致软件枚举无法检测到SSD。
4. PCIe BAR配置位256MB，刚好和AXI BAR一样大小，给Root BAR分配了空间，反而SSD BAR报`No room in resource`。
5. Unsupport Request，这次的原因是AXI2PCIe Translation忘记配置。

```bash
write_cfgmem -force -format BIN -interface SPIx4 -size 512 -loadbit "up 0x0 C:/dog/tftp/mwm1132/MWM1132_4TB_V1_U20_V1.bit" C:/dog/tftp/mwm1132/MWM1132_4TB_V1_U20_V1.bin

xsct% connect
xsct% target 1
xsct% fpga C:/dog/tftp/mwm1132/MWM1132_4TB_V1_U20_V1.bit
xsct% target 3
xsct% jtagterminal
xsct% rst -processor
xsct% dow C:/dog/program/sdk2018.2/mwm1132/Debug/mwm1132.elf
xsct% con

root@microblaze:nvme readmq 0 1 0 0x10000 0x100000000 64
status: time=1015ms, size=1912602624Bytes, speed=1884MB/s
total : time=1144ms, size=2147483648Bytes, speed=1877MB/s
root@microblaze:nvme readmq 1 1 0 0x10000 0x100000000 64
status: time=1003ms, size=1879048192Bytes, speed=1873MB/s
total : time=1150ms, size=2147483648Bytes, speed=1867MB/s
root@microblaze:nvme writemq 1 1 0 0x10000 0x100000000 64
status: time=1002ms, size=973078528Bytes, speed= 971MB/s
status: time=1021ms, size=1006632960Bytes, speed= 985MB/s
total : time=2217ms, size=2147483648Bytes, speed= 968MB/s
root@microblaze:nvme writemq 0 1 0 0x10000 0x100000000 64
status: time=1022ms, size=1006632960Bytes, speed= 984MB/s
status: time=1001ms, size=973078528Bytes, speed= 972MB/s
total : time=2200ms, size=2147483648Bytes, speed= 976MB/s
# 读速度从1.8GB/s降到1.4GB/s，因为FPGA把AXI Interconnect时钟降到了100MHz？
root@microblaze:nvme readmq 0 1 0 0x10000 0x100000000 64
status: time=1002ms, size=1342177280Bytes, speed=1339MB/s
total : time=1607ms, size=2147483648Bytes, speed=1336MB/s
root@microblaze:nvme readmq 1 1 0 0x10000 0x100000000 64
status: time=1005ms, size=1308622848Bytes, speed=1302MB/s
total : time=1653ms, size=2147483648Bytes, speed=1299MB/s
root@microblaze:nvme writemq 1 1 0 0x10000 0x100000000 64
status: time=1006ms, size=905969664Bytes, speed= 900MB/s
status: time=1016ms, size=905969664Bytes, speed= 891MB/s
total : time=2401ms, size=2147483648Bytes, speed= 894MB/s
root@microblaze:nvme writemq 0 1 0 0x10000 0x100000000 64
status: time=1014ms, size=905969664Bytes, speed= 893MB/s
status: time=1002ms, size=905969664Bytes, speed= 904MB/s
total : time=2395ms, size=2147483648Bytes, speed= 896MB/s
```

# mwm1153_m350
tx delay设置0xf8~0xfb,0xff可以iperf3，但是速度比百兆网还慢，百兆可以满速运行，后面定位是z7 mio的bank电压（1.8V）配置引脚搞错了，配置引脚改了之后，FPGA hdf也需要更新，没更新导致网络，emmc都不能用，硬件更改完成之后，delay保持默认值0xf1即可。设置0xff，没影响iperf3速度，测了几次低1MB/s左右。
```bash
zynq-uboot> mii device
MII devices: 'Gem.e000b000' 'Gem.e000c000' 
Current device: 'Gem.e000b000'
zynq-uboot> mii write 1 0x1e 0xa003
zynq-uboot> mii read 1 0x1f
00F1
zynq-uboot> mii write 1 0x1f 0xff
zynq-uboot> mii read 1 0x1f
00FF

# linux
root@zynq:~# phytool write eth0/1/0x1e/0xa003
root@zynq:~# phytool read eth0/1/0x1f
root@zynq:~# phytool write eth0/1/0x1f 0xfa
root@zynq:~# iperf3 -c 192.168.26.6
Connecting to host 192.168.26.6, port 5201
[  4] local 192.168.26.195 port 46404 connected to 192.168.26.6 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec  3.93 MBytes  32.9 Mbits/sec  555   1.43 KBytes       
[  4]   1.00-2.00   sec  2.51 MBytes  21.1 Mbits/sec  416    104 KBytes       
root@zynq:/boot# iperf3 -c 192.168.26.10
Connecting to host 192.168.26.10, port 5201
[  4] local 192.168.26.195 port 60364 connected to 192.168.26.10 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.01   sec  81.7 MBytes   681 Mbits/sec    0   69.9 KBytes       
[  4]   1.01-2.01   sec  81.1 MBytes   682 Mbits/sec    0   69.9 KBytes       
[  4]   2.01-3.01   sec  81.2 MBytes   682 Mbits/sec    0   69.9 KBytes       
[  4]   3.01-4.01   sec  81.2 MBytes   681 Mbits/sec    0   69.9 KBytes       
[  4]   4.01-5.01   sec  81.1 MBytes   680 Mbits/sec    0   69.9 KBytes       
[  4]   5.01-6.01   sec  81.2 MBytes   681 Mbits/sec    0   69.9 KBytes       
[  4]   6.01-7.01   sec  81.2 MBytes   681 Mbits/sec    0   69.9 KBytes       
[  4]   7.01-8.01   sec  81.2 MBytes   682 Mbits/sec    0   69.9 KBytes       
[  4]   8.01-9.01   sec  81.2 MBytes   681 Mbits/sec    0   69.9 KBytes       
[  4]   9.01-10.01  sec  81.2 MBytes   681 Mbits/sec    0   69.9 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.01  sec   812 MBytes   681 Mbits/sec    0             sender
[  4]   0.00-10.01  sec   812 MBytes   681 Mbits/sec                  receiver

iperf Done.
root@zynq:/boot# iperf3 -c 192.168.26.10 -A 2
iperf3: error - unable to set CPU affinity: Invalid argument
root@zynq:/boot# iperf3 -c 192.168.26.10 -A 1
Connecting to host 192.168.26.10, port 5201
[  4] local 192.168.26.195 port 60366 connected to 192.168.26.10 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec  96.5 MBytes   808 Mbits/sec    0   67.0 KBytes       
[  4]   1.00-2.00   sec  98.6 MBytes   826 Mbits/sec    0   67.0 KBytes       
[  4]   2.00-3.00   sec   100 MBytes   841 Mbits/sec    0   67.0 KBytes       
[  4]   3.00-4.00   sec   100 MBytes   839 Mbits/sec    0   67.0 KBytes       
[  4]   4.00-5.00   sec  99.9 MBytes   840 Mbits/sec    0   67.0 KBytes       
[  4]   5.00-6.00   sec   100 MBytes   839 Mbits/sec    0   67.0 KBytes       
[  4]   6.00-7.00   sec   100 MBytes   841 Mbits/sec    0   67.0 KBytes       
[  4]   7.00-8.00   sec   101 MBytes   842 Mbits/sec    0   67.0 KBytes       
[  4]   8.00-9.00   sec   100 MBytes   843 Mbits/sec    0   67.0 KBytes       
[  4]   9.00-10.00  sec   100 MBytes   840 Mbits/sec    0   67.0 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec   997 MBytes   836 Mbits/sec    0             sender
[  4]   0.00-10.00  sec   996 MBytes   836 Mbits/sec                  receiver

iperf Done.
```

# mwm1106

```bash
$ cd /boot && tftp -l MWM1106JLB_V2_U34_V1.bit -r MWM1106JLB_V2_U34_V1_4q_intr8.bit -g 192.168.26.6 && sync && cd
$ cd /boot && tftp -r system.dtb -g 192.168.26.6 && sync && cd
$ cd /boot && tftp -r Image -g 192.168.26.6 && sync && cd

# 开机脚本
$ cat start.sh 
#!/bin/sh

echo 406 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio406/direction
echo 0 > /sys/class/gpio/gpio406/value
# 设置窗大小，没什么作用其实
echo 16777216 > /proc/sys/net/core/rmem_max
echo 16777216 > /proc/sys/net/core/rmem_default
echo 16777216 > /proc/sys/net/core/wmem_max
echo 16777216 > /proc/sys/net/core/wmem_default

ifconfig eth1 192.168.5.5
ifconfig eth2 192.168.4.5
sleep 1
ethtool -s eth1 autoneg off
ethtool -s eth2 autoneg off

ifconfig eth3 192.168.3.5
# 两个队列4个中断
# 2个发送中断在CPU0，2个接收中断在CPU1，这样对性能无提升
# 队列1的发送接收中断都在CPU0，队列2的发送接收中断都在CPU1，内核在多个iperf3测试时直接挂掉
echo 2 > /proc/irq/46/smp_affinity
echo 2 > /proc/irq/47/smp_affinity

# 关看门狗
$ echo $(expr 68 + 338) > /sys/class/gpio/export
$ echo in > /sys/class/gpio/gpio406/direction
$ cat /sys/class/gpio/gpio406/value
# 10G/40G
$ cat /proc/interrupts | grep eth3
 42:     340002          0          0          0     GICv2 124 Level     eth3, eth3
 43:        140     895272          0          0     GICv2 125 Level     eth3, eth3
$ echo 2 > /proc/irq/43/smp_affinity
$ iperf3 -c 192.168.3.16 -w 4M -A 2 -t 1000
$ iperf3 -c 192.168.3.16 -p 5202 -w 4M -A 3 -t 1000
$ iperf3 -s
$ iperf3 -s -p 5202
```
usb无法识别，本来这个在mwm1129的usb1上出现，适用于usb3315/usb3317，但usb3320应该是没有这个bug的，在uboot下添加命令，需要设置clk管脚为pull down/disable模式，这样usb3315才能输出时钟给zynqmp，
```bash
ZynqMP> setenv default_bootcmd "mw 0xFF18017C 0x3fffffe && gpio clear 72 && gpio set 72; run ext4_booticmd"
ZynqMP> saveenv
ZynqMP> saveenv
```

# pcierc-zc706
```bash
zynq-uboot> setenv fpga_img pcierc_wrapper_gen2_x4_toe.bit
zynq-uboot> setenv Gem.e000b000_phyaddr 7
zynq-uboot> setenv ipaddr 192.168.26.21
zynq-uboot> setenv serverip 192.168.26.6
zynq-uboot> setenv gatewayip 192.168.26.254
zynq-uboot> setenv ext4_kernel_bu_flag 1

# PCIe卡死之后通过xpcie=0进行部署
zynq-uboot> setenv ext4_bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200 noinitrd earlyprintk root=/dev/mmcblk0p1 rootfstype=ext4 rw rootwait xpcie=0'
zynq-uboot> setenv net_bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200  rootfstype=ext4 initrd=0x4000040,0x4000000 root=/dev/ram0 rw xpcie=0'
zynq-uboot> run ext4_bringup
# 部署完成后恢复
zynq-uboot> setenv ext4_bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200 noinitrd earlyprintk root=/dev/mmcblk0p1 rootfstype=ext4 rw rootwait'
zynq-uboot> setenv net_bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200  rootfstype=ext4 initrd=0x4000040,0x4000000 root=/dev/ram0 rw'
# 测试zynq petalinux 2018.2 linux with 2015.2.1 u-boot
zynq-uboot> setenv fit_bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200'
zynq-uboot> setenv bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200'
zynq-uboot> setenv bootargs $fit_bootargs
zynq-uboot> run ext4_fpga_boot
zynq-uboot> run netboot
zynq-uboot> setenv bootargs $fit_bootargs && run ext4_fpga_boot && run netboot
# 测试zynq petalinux 2018.2 linux with 2018.2 u-boot
Zynq> setenv boot_img boot-2018.2.bin
Zynq> tftpboot ${clobstart} pcierc_wrapper_gen2_x4_toe.bit && fpga loadb 0 ${clobstart} ${filesize}
Zynq> setenv test_img 'setenv var "if test 0x${filesize} -gt ${psize}; then run fault; else run ${installcmd}; fi"; run var; setenv var'
Zynq> run update_kernel
```
```bash
# 读取DDR是否初始化成功，mio[53:0], so emio0 is from 54
$ echo $(expr 54 + 906) > /sys/class/gpio/export
$ echo in > /sys/class/gpio/gpio960/direction
$ cat /sys/class/gpio/gpio960/value

$ cd /boot && tftp -r download.bit -g 192.168.2.227 && sync && cd
$ cd /boot && tftp -r uImage -g 192.168.26.6 && sync && cd
$ cd /boot && tftp -r pcierc_wrapper_gen2_x4.bit -g 192.168.26.6 && sync && cd
$ cd /boot && tftp -r pcierc_wrapper_gen1_x1.bit -g 192.168.26.6 && sync && cd

$ cd ~/fdk_develop
$ ./develop.sh -t zynq -b package nvme_chipset
$ cp -vf /home/qe/program/fdk/bsp/zynq/package-v2015.2.1/module/nvme_chipset.ko /mnt/hgfs/dog/tftp/pcierc-zc706
$ ./develop.sh -t zynq -b package nvme_chipset && cp -vf /home/qe/program/fdk/bsp/zynq/package-v2015.2.1/module/nvme_chipset.ko /mnt/hgfs/dog/tftp/pcierc-zc706
$ tftp -r nvme_chipset.ko -g 192.168.26.6 && sync
$ modprobe backlight && insmod nvme_chipset.ko
$ fdk -b kernel
$ cp ~/program/fdk/bsp/zynq/linux-xlnx-v2015.2.1/drivers/block/nvme.ko /mnt/hgfs/dog/tftp/pcierc-zc706
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/block && tftp -r nvme.ko -g 192.168.26.6 && sync && cd
$ modprobe nvme
$ cd /bin && tftp -r nvmel_benchmark -g 192.168.26.6 && chmod +x nvmel_benchmark && sync && cd

# 测试zynq petalinux 2018.2
$ petalinux-build
$ cp images/linux/image.ub /mnt/hgfs/dog/tftp/pcierc-zc706

# 测试microblaze
# SDK工程右键C/C++ Build Settings->Miscellaneous添加-Wno-char-subscripts
xsct% connect
xsct% target 6    
xsct% jtagterminal
xsct% rst -processor
xsct% dow C:/dog/program/sdk2018.2/nvme_mb_zc706/Debug/nvme_mb_zc706.elf
xsct% con
Zynq> setenv bootargs 'earlycon clk_ignore_unused console=ttyPS0,115200 noinitrd earlyprintk root=/dev/mmcblk0p1 rootfstype=ext4 rw rootwait'
$ modprobe nvme
$ nvmel_benchmark -i shm0x50030000
$ memtool md 0x50030000 # hm
$ memtool md 0x50030818 # cm
$ nvmel_benchmark -r -w /dev/nvme0n1 -p cmem -s 0 -l 0x400000 -n 4096 -t 0
$ nvmel_benchmark -r -w shm0x50030000d0n1 -p cmem -s 0 -l 0x400000 -n 4096 -t 0
$ nvmel_benchmark -r shm0x50030000d0n1 -p 0x40000000 -s 0 -l 0x400000
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/fdk && tftp -r cmem.ko -g 192.168.26.6 && sync && cd

# microblaze
nvme read 0 1 0 256 0x40000000 1
```

# zynq_cr_pcie
- Intel 7260AC必须在PCIe Gen1x1才能工作，在Gen2x4下可以识别，访问Bar空间会挂掉。
- Qualcomm QCA6174，FPGA必须在模块复位后加载，即模块复位完成之后，才能开始PCIe Link，否则会报`Slave Completer Abort`，这个时候重启是没有用的，可能是某种不正常的复位导致模块进入的异常状态， 在FPGA工程删除perst后，问题解决。后面将程序移植到黑金AX7350上时，发现开发板上的perst管脚经过了一个电平转换芯片到3.3V才给到外面，可能是这个问题。黑金的板子复现了`Slave Complete Abort`问题，但是黑金自带的demo可用，有三个不同，一是perst连接axi_ctl_aclk_out的复位模块输出，二是axi_pcie IP的axi_aresetn接的是peripheral_aresetn，我接了interconnect_aresetn，三是在vivado2018.2里面axi_pcie IP的xdc要禁用，在Systhesis，Implememtation里面都要禁用，黑金只禁用了Systhesis却也能干活，可能因为它是vivado2017.4。
```bash
zynq-uboot> setenv serverip 192.168.2.227
zynq-uboot> setenv ipaddr 192.168.2.100
zynq-uboot> setenv gatewayip 192.168.2.1
zynq-uboot> ping www.baidu.com
ping - send ICMP ECHO_REQUEST to network host

Usage:
ping pingAddress
$ nslookup www.baidu.com
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
www.baidu.com	canonical name = www.a.shifen.com.
Name:	www.a.shifen.com
Address: 183.232.231.172
Name:	www.a.shifen.com
Address: 183.232.231.174
zynq-uboot> ping 183.232.231.172
Gem.e000b000 Waiting for PHY auto negotiation to complete...... done
Gem.e000b000: link UP, phyaddr: 1, speed: 100.
Using Gem.e000b000 device
host 183.232.231.172 is alive
zynq-uboot> run update_boot
```
```bash
# linux
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/net/wireless/rtlwifi && tftp -r rtl_pci.ko -g 192.168.26.6 && sync && cd
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/net/wireless/rtlwifi && tftp -r rtlwifi.ko -g 192.168.26.6 && sync && cd
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/net/wireless/rtlwifi/rtl8192ee && tftp -r rtl8192ee.ko -g 192.168.26.6 && sync && cd
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/net/wireless/rtlwifi/btcoexist && tftp -r btcoexist.ko -g 192.168.26.6 && sync && cd
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/kernel/drivers/net/wireless/ath/ath10k && tftp -r ath10k_pci.ko -g 192.168.26.6 && depmod && sync && cd
$ modprobe ath10k_pci
$ cd /boot && tftp -r download.bit -g 192.168.2.227 && sync && cd
$ cd /boot && tftp -r uImage -g 192.168.26.6 && sync && cd

$ source /opt/Xilinx/Vivado/2018.2/settings64.sh  && cd ~/project/vivado/2018.2/zynq_cr_pcie && vivado zynq_cr_pcie.xpr

# intel 7260ac
$ mkdir -p /lib/firmware
$ cd /lib/firmware
$ tftp -r iwlwifi-7260-9.ucode -g 192.168.26.6
$ tftp -r iwlwifi-7260-10.ucode -g 192.168.26.6
$ tftp -r iwlwifi-7260-12.ucode -g 192.168.26.6
$ modprobe iwlwifi
# 通过wpa_cli连接wifi
$ cat wpa_supplicant.conf # 准备配置文件
ctrl_interface=/var/run/wpa_supplicant
eapol_version=1
ap_scan=1
fast_reauth=1
$ rfkill unblock all
$ rfkill list
0: phy0: Wireless LAN
        Soft blocked: no
        Hard blocked: no
$ ifconfig wlan0 up
iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled
iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled
IPv6: ADDRCONF(NETDEV_UP): wlan0: link is not ready
$ wpa_supplicant -iwlan0 -c./wpa_supplicant.conf -B
Successfully initialized wpa_supplicant
rfkill: Cannot open RFKILL control device
rfkill: Cannot get wiphy information # 需要在内核使能RF switch subsystem support
$ wpa_cli -iwlan0 # wpa_cli -iwlan0 -p/var/run/wpa_supplicant
> status
wpa_state=DISCONNECTED
p2p_device_address=48:51:b7:5a:28:38
address=48:51:b7:5a:28:37
uuid=c911a258-ace6-5d0d-9800-6ba4dcd31b49
> scan # 没安装天线之前一直扫不到
OK
<3>CTRL-EVENT-SCAN-STARTED 
<3>CTRL-EVENT-SCAN-RESULTS 
<3>CTRL-EVENT-NETWORK-NOT-FOUND 
> scan_results
bssid / frequency / signal level / flags / ssid
f2:c3:35:d2:85:e9       2437    -75     [WPA2-PSK-CCMP][ESS]    Redmi K30 Pro
> add_network
0
> set_network 0 ssid "Redmi K30 Pro"
OK
> set_network 0 psk "zhu***"
OK
> enable_network 0
OK
<3>CTRL-EVENT-SCAN-STARTED 
<3>CTRL-EVENT-SCAN-RESULTS 
<3>SME: Trying to authenticate with f2:c3:35:d2:85:e9 (SSID='Redmi K30 Pro' freq=2437 MHz)
<3>Trying to associate with f2:c3:35:d2:85:e9 (SSID='Redmi K30 Pro' freq=2437 MHz)
<3>Associated with f2:c3:35:d2:85:e9
<3>CTRL-EVENT-SUBNET-STATUS-UPDATE status=0
<3>WPA: Key negotiation completed with f2:c3:35:d2:85:e9 [PTK=CCMP GTK=CCMP]
<3>CTRL-EVENT-CONNECTED - Connection to f2:c3:35:d2:85:e9 completed [id=0 id_str=]
> status
bssid=f2:c3:35:d2:85:e9
freq=2437
ssid=Redmi K30 Pro
id=0
mode=station
pairwise_cipher=CCMP
group_cipher=CCMP
key_mgmt=WPA2-PSK
wpa_state=COMPLETED
p2p_device_address=48:51:b7:5a:28:38
address=48:51:b7:5a:28:37
uuid=c911a258-ace6-5d0d-9800-6ba4dcd31b49
> quit
$ udhcpc -iwlan0
udhcpc (v1.23.1) started
Sending discover...
Sending select for 192.168.43.9...
Lease of 192.168.43.9 obtained, lease time 3599
/etc/udhcpc.d/50default: Adding DNS 192.168.43.1
$ ping 192.168.43.69 # 连接同一手机热点的电脑
$ iperf3 -c 192.168.43.69 # 手机热点应该是只分配了10M以太网的带宽
Connecting to host 192.168.43.69, port 5201
[  4] local 192.168.43.9 port 33459 connected to 192.168.43.69 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec   955 KBytes  7.82 Mbits/sec    0   54.2 KBytes       
[  4]   1.00-2.00   sec  1.10 MBytes  9.23 Mbits/sec    0   54.2 KBytes       
[  4]   2.00-3.00   sec  1.01 MBytes  8.50 Mbits/sec    0   54.2 KBytes       
[  4]   3.00-4.00   sec  1.48 MBytes  12.4 Mbits/sec    0   91.2 KBytes       
[  4]   4.00-5.00   sec  1.57 MBytes  13.1 Mbits/sec    0    108 KBytes       
[  4]   5.00-6.00   sec  1.53 MBytes  12.9 Mbits/sec    0    137 KBytes       
[  4]   6.00-7.00   sec  1.46 MBytes  12.2 Mbits/sec    0    137 KBytes       
[  4]   7.00-8.00   sec  1.33 MBytes  11.1 Mbits/sec    0    154 KBytes       
[  4]   8.00-9.00   sec  1.57 MBytes  13.2 Mbits/sec    0    311 KBytes       
[  4]   9.00-10.00  sec  1.44 MBytes  12.1 Mbits/sec    0    311 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec  13.4 MBytes  11.3 Mbits/sec    0             sender
[  4]   0.00-10.00  sec  13.0 MBytes  10.9 Mbits/sec                  receiver
$ ping -I wlan0 www.baidu.com
# 更新配置文件
$ cat wpa_supplicant.conf 
ctrl_interface=/var/run/wpa_supplicant
eapol_version=1
ap_scan=1
fast_reauth=1
network={
        ssid="Redmi K30 Pro"
        psk="zhuce1994"
        priority=5
}
$ wpa_supplicant -iwlan0 -c./wpa_supplicant.conf -B
Successfully initialized wpa_supplicant
root@zynq:~/wifi/wpa_supplicant# wlan0: authenticate with f2:c3:35:d2:85:e9
wlan0: send auth to f2:c3:35:d2:85:e9 (try 1/3)
wlan0: authenticated
wlan0: associate with f2:c3:35:d2:85:e9 (try 1/3)
wlan0: RX AssocResp from f2:c3:35:d2:85:e9 (capab=0x1431 status=0 aid=3)
wlan0: associated
# 最终开机脚本配置
root@zynq:~# cat start.sh 
#!/bin/sh

modprobe iwlwifi
modprobe ath10k_pci
modprobe rtl8192ee debug=5 # debug打开调试打印，串口不会直接输出，通过dmesg可看到
sleep 1
ifconfig wlan0 up
sleep 1
cd ~/wifi/wpa_supplicant
./wpa_supplicant -iwlan0 -c./wpa_supplicant.conf -B
udhcpc -i wlan0 -b -R -p /var/run/udhcpc.pid
# ping -Iwlan0 www.baidu.com

# Realtek
[    1.184450] pci 0000:00:00.0: enabling device (0000 -> 0002)
[    1.189952] rtl8192ee 0000:01:00.0: enabling device (0000 -> 0002)
[    1.204069] rtl8192ee: Using firmware rtlwifi/rtl8192eefw.bin
[    1.212133] rtl_pci: Cannot allocate TX ring (prio = 6)
[    1.219353] rtl_pci: tx ring initialization failed
[    1.223961] rtl_pci: Failed to init PCI
[    1.227795] rtl8192ee 0000:01:00.0: Driver probe function unexpectedly returned 1
...
[    1.275066] rtl8192ee 0000:01:00.0: Direct firmware load for rtlwifi/rtl8192eefw.bin failed with error -2
[    1.284446] rtlwifi: Selected firmware is not available

$ mkdir -p /lib/firmware/rtlwifi
$ cd /lib/firmware/rtlwifi 
$ tftp -r rtl8192eefw.bin -g 192.168.26.6
https://lists.openwall.net/netdev/2014/06/23/84
https://blog.csdn.net/u014674293/article/details/89853415
[    1.184111] pci 0000:00:00.0: enabling device (0000 -> 0002)
[    1.189606] rtl8192ee 0000:01:00.0: enabling device (0000 -> 0002)
[    1.203738] rtl8192ee: Using firmware rtlwifi/rtl8192eefw.bin
[    1.209387] rtl8192ee 0000:01:00.0: Direct firmware load for rtlwifi/rtl8192eefw.bin failed with error -2
[    1.218819] rtlwifi: Selected firmware is not available
[    1.227714] rtlwifi: rtlwifi: wireless switch is on

# Qualcomm Atheros QCA6174 802.11ac Wireless Network Adapter (rev 32)
pci 0000:00:00.0: enabling device (0140 -> 0142)
ath10k_pci 0000:01:00.0: enabling device (0140 -> 0142)
ath10k_pci 0000:01:00.0: pci irq msi oper_irq_mode 2 irq_mode 0 reset_mode 0
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/pre-cal-pci-0000:01:00.0.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/cal-pci-0000:01:00.0.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-6.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-5.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-4.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-3.bin failed with error -2
ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-2.bin failed with error -2
ath10k_pci 0000:01:00.0: Failed to find firmware-N.bin (N between 2 and 6) from ath10k/QCA6174/hw3.0: -2
ath10k_pci 0000:01:00.0: could not fetch firmware files (-2)
ath10k_pci 0000:01:00.0: could not probe fw (-2)
# intel 7260ac
pci 0000:00:00.0: enabling device (0140 -> 0142)
iwlwifi 0000:01:00.0: enabling device (0140 -> 0142)
iwlwifi 0000:01:00.0: loaded firmware version 17.948900127.0 op_mode iwlmvm
iwlwifi 0000:01:00.0: Detected Intel(R) Dual Band Wireless AC 7260, REV=0x144
iwlwifi 0000:01:00.0: base HW address: e4:70:b8:48:9b:a8


$ tftp -r wpa_supplicant_2018 -g 192.168.26.6
$ chmod +x wpa_supplicant_2018 
$ tftp -r wpa_cli_2018 -g 192.168.26.6          
$ chmod +x wpa_cli_2018        
$ tftp -r wpa_supplicant.conf -g 192.168.26.6
$ ./wpa_supplicant_2018 -iwlan0 -c./wpa_supplicant.conf -B
$ udhcpc -i wlan0 -b -R -p /var/run/udhcpc.pid
$ ping -I wlan0 www.baidu.com
```
petalinux2018.2操作流程，
```bash
# 配置内核，开启WIFI支持
$ petalinux-config -c kernel
# 编译
$ petalinux-build
# petalinux创建BOOT.BIN
$ petalinux-package --boot --fpga images/linux/system_wrapper.bit --u-boot --force
INFO: Getting system flash information...
rlwrap: warning: your $TERM is 'xterm-256color' but rlwrap couldn't find it in the terminfo database. Expect some problems.: Inappropriate ioctl for device
                                                                                                                                                                                                                                                                                   
INFO: File in BOOT BIN: "/home/developer/project/zynq-v2018.2/images/linux/zynq_fsbl.elf"
INFO: File in BOOT BIN: "/home/developer/project/zynq-v2018.2/images/linux/system_wrapper.bit"
INFO: File in BOOT BIN: "/home/developer/project/zynq-v2018.2/images/linux/u-boot.elf"
INFO: Generating zynq binary package BOOT.BIN...


****** Xilinx Bootgen v2018.2
  **** Build date : Jun 14 2018-20:09:18
    ** Copyright 1986-2018 Xilinx, Inc. All Rights Reserved.

INFO: Binary is ready.
# linux
$ killall hostapd
$ vi /etc/wpa_supplicant.conf 
$ wpa_supplicant -iwlan0 -c/etc/wpa_supplicant.conf -B
$ udhcpc -i wlan0 -b -R -p /var/run/udhcpc.pid
$ ping www.baidu.com
```
petalinux2018.2增加firmware，
```bash
#
# This file is the myfw recipe.
#

SUMMARY = "Simple myfw application"
SECTION = "PETALINUX/apps"
LICENSE = "MIT"
LIC_FILES_CHKSUM = "file://${COMMON_LICENSE_DIR}/MIT;md5=0835ade698e0bcf8506ecda2f7b4f302"

SRC_URI = "file://rtlwifi/rtl8192eefw.bin \
file://ath10k/QCA6174/hw3.0/board.bin \
file://ath10k/QCA6174/hw3.0/board-2.bin \
file://ath10k/QCA6174/hw3.0/firmware-4.bin \
file://ath10k/QCA6174/hw3.0/firmware-6.bin \
file://ath10k/QCA988X/hw2.0/board.bin \
file://ath10k/QCA988X/hw2.0/firmware-4.bin \
file://ath10k/QCA988X/hw2.0/firmware-5.bin \
file://iwlwifi-7260-7.ucode \
file://iwlwifi-7260-8.ucode \
file://iwlwifi-7260-9.ucode \
file://iwlwifi-7260-10.ucode \
file://iwlwifi-7260-12.ucode \
file://iwlwifi-7260-13.ucode \
file://iwlwifi-7260-16.ucode \
file://iwlwifi-7260-17.ucode \
	"

S = "${WORKDIR}"

do_install() {
	     install -d ${D}/${base_libdir}/firmware/rtlwifi
	     install -m 0755 ${S}/rtlwifi/rtl8192eefw.bin ${D}/${base_libdir}/firmware/rtlwifi
	     install -d ${D}/${base_libdir}/firmware/ath10k/QCA6174/hw3.0
	     install -m 0755 ${S}/ath10k/QCA6174/hw3.0/board.bin ${D}/${base_libdir}/firmware/ath10k/QCA6174/hw3.0
	     install -m 0755 ${S}/ath10k/QCA6174/hw3.0/board-2.bin ${D}/${base_libdir}/firmware/ath10k/QCA6174/hw3.0
	     install -m 0755 ${S}/ath10k/QCA6174/hw3.0/firmware-4.bin ${D}/${base_libdir}/firmware/ath10k/QCA6174/hw3.0
	     install -m 0755 ${S}/ath10k/QCA6174/hw3.0/firmware-6.bin ${D}/${base_libdir}/firmware/ath10k/QCA6174/hw3.0
	     install -d ${D}/${base_libdir}/firmware/ath10k/QCA988X/hw2.0
	     install -m 0755 ${S}/ath10k/QCA988X/hw2.0/board.bin ${D}/${base_libdir}/firmware/ath10k/QCA988X/hw2.0
	     install -m 0755 ${S}/ath10k/QCA988X/hw2.0/firmware-4.bin ${D}/${base_libdir}/firmware/ath10k/QCA988X/hw2.0
	     install -m 0755 ${S}/ath10k/QCA988X/hw2.0/firmware-5.bin ${D}/${base_libdir}/firmware/ath10k/QCA988X/hw2.0
	     install -m 0755 ${S}/iwlwifi-7260-7.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-8.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-9.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-10.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-12.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-13.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-16.ucode ${D}/${base_libdir}/firmware
	     install -m 0755 ${S}/iwlwifi-7260-17.ucode ${D}/${base_libdir}/firmware
}

FILES_${PN} = "${base_libdir}/firmware"
```
也可以直接通过Yocto增加`linux-firmware`但我估计比较大，Flash空间告急，
```bash
IMAGE_INSTALL_append = " myfw"
# IMAGE_INSTALL_append = " linux-firmware"
IMAGE_INSTALL_append = " iperf3"
IMAGE_INSTALL_append = " wpa-supplicant"
IMAGE_INSTALL_append = " hostapd"
IMAGE_INSTALL_append = " iw"
```
黑金开发板，更改petalinux2018.2 fsbl，
```c
u32 FsblHookBeforeHandoff(void)
{
	u32 Status;

	Status = XST_SUCCESS;

	/*
	 * User logic to be added here.
	 * Errors to be stored in the status variable and returned
	 */
	fsbl_printf(DEBUG_INFO,"In FsblHookBeforeHandoff function \r\n");

	// Configure Si5338
	xil_printf("-------------------------\r\n");
	xil_printf("Configure PLL\r\n");
	Status = si5338_init(XPAR_XIICPS_0_DEVICE_ID, 0x00, 0x70);
	xil_printf("-------------------------\r\n");
	usleep(100*1000);

	return (Status);
}
```
步骤，
```bash
1. 敲击任何键停在u-boot下面，利用网络下载Linux Image
2. 配置IP，配置电脑IP和开发板同一网段，检测网络是否通畅
Zynq> printenv ipaddr
ipaddr=192.168.26.21
Zynq> ping 192.168.26.6
Using ethernet@e000b000 device
host 192.168.26.6 is alive
3. 配置TFTP服务器
4. 在u-boot下执行命令
Zynq> setenv kernelsize 1600000
Zynq> run update_kernel
5. 启动Linux
Zynq> boot

1. 更新boot
Zynq> setenv bootsize 900000
Zynq> run update_boot
```
2015.2按照黑金更新完复位之后，可以使用了，使用固件`ath10k-firmware-master\QCA988X\hw2.0\10.2\firmware-3.bin_10.2.2.39.6-1`和`board.bin`。STA模式速度2MB/s，调整窗口参数不影响wifi速度。QCA988X STA模式，Zynq iperf3 server可以跑到11MB/s，client却只有4MB/s。
```bash
$ lspci -vv
01:00.0 Network controller: Qualcomm Atheros QCA988x 802.11ac Wireless Network Adapter
$ tftp -r wpa_supplicant.sh -g 192.168.26.6
$ chmod +x wpa_supplicant.sh
$ cat wpa_supplicant.sh 
#!/bin/sh

# modprobe iwlwifi
modprobe ath10k_pci
# modprobe rtl8192ee
./wpa_supplicant -iwlan0 -c./wpa_supplicant.conf -B
udhcpc -i wlan0 -b -R -p /var/run/udhcpc.pid
$ chmod +x wifi.sh 
$ tftp -r wpa_supplicant -g 192.168.26.6
$ chmod +x wpa_supplicant
$ tftp -r wpa_supplicant.conf -g 192.168.26.6
$ cat wpa_supplicant.conf 
ctrl_interface=/var/run/wpa_supplicant
eapol_version=1
ap_scan=1
fast_reauth=1
network={
        ssid="Redmi K30 Pro"
        psk="zhuce1994"
        priority=5
}
network={
        ssid="yuzi5g"
        psk="zhuce19940828"
        priority=1
}
$ ./wpa_supplicant.sh
$ iperf3 -c 192.168.43.69
Connecting to host 192.168.43.69, port 5201
[  4] local 192.168.43.212 port 33582 connected to 192.168.43.69 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.00   sec  3.09 MBytes  25.9 Mbits/sec    0    192 KBytes       
[  4]   1.00-2.00   sec  2.96 MBytes  24.9 Mbits/sec    0    212 KBytes       
[  4]   2.00-3.00   sec  2.92 MBytes  24.5 Mbits/sec    0    212 KBytes       
[  4]   3.00-4.00   sec  2.79 MBytes  23.4 Mbits/sec    0    212 KBytes       
[  4]   4.00-5.00   sec  2.53 MBytes  21.2 Mbits/sec    0    212 KBytes       
[  4]   5.00-6.00   sec  2.27 MBytes  19.0 Mbits/sec    0    212 KBytes       
[  4]   6.00-7.00   sec  2.39 MBytes  20.0 Mbits/sec    0    212 KBytes       
[  4]   7.00-8.00   sec  1.22 MBytes  10.2 Mbits/sec    0   2.85 KBytes       
[  4]   8.00-9.00   sec  97.0 KBytes   794 Kbits/sec    4   98.4 KBytes       
[  4]   9.00-10.00  sec  82.7 KBytes   677 Kbits/sec    1    123 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec  20.3 MBytes  17.1 Mbits/sec    5             sender
[  4]   0.00-10.00  sec  19.9 MBytes  16.7 Mbits/sec                  receiver

iperf Done.
$ iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.69, port 50742
[  5] local 192.168.43.212 port 5201 connected to 192.168.43.69 port 50743
[ ID] Interval           Transfer     Bandwidth
[  5]   0.00-1.00   sec  3.00 MBytes  25.2 Mbits/sec                  
[  5]   1.00-2.00   sec  3.09 MBytes  25.9 Mbits/sec                  
[  5]   2.00-3.00   sec  2.91 MBytes  24.4 Mbits/sec                  
[  5]   3.00-4.00   sec  3.04 MBytes  25.5 Mbits/sec                  
[  5]   4.00-5.00   sec  3.09 MBytes  25.9 Mbits/sec                  
[  5]   5.00-6.00   sec  2.78 MBytes  23.3 Mbits/sec                  
[  5]   6.00-7.00   sec  2.50 MBytes  21.0 Mbits/sec                  
[  5]   7.00-8.00   sec  2.64 MBytes  22.2 Mbits/sec                  
[  5]   8.00-9.00   sec  3.01 MBytes  25.3 Mbits/sec                  
[  5]   9.00-10.00  sec  2.97 MBytes  24.9 Mbits/sec                  
[  5]  10.00-10.07  sec   223 KBytes  27.3 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth
[  5]   0.00-10.07  sec  0.00 Bytes  0.00 bits/sec                  sender
[  5]   0.00-10.07  sec  29.2 MBytes  24.4 Mbits/sec                  receiver
$ tftp -r hostapd -g 192.168.26.6
$ chmod +x hostapd
$ tftp -r hostapd.conf -g 192.168.26.6
$ cat hostapd.conf 
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0
#无线设备名称，基本都是wlan0，可用iwconfig命令查看
interface=wlan0

#使用的网桥名称，如果是用DHCP+NAT方式可忽略此行
#bridge=br0  

#hostapd 0.6.8或者更高版本唯一选择
driver=nl80211

#终端看到的wifi名称，请自行修改
ssid=zynq_cr_pcie


#指明要选用的无线传输协议，这里表示使用802.11g
hw_mode=g
ieee80211n=1 # 802.11n速度会提升

#802.11b/g都至多只有三条互不干扰的信道，即1,6,11，一般填这三个其中一个    
channel=1 

#验证身份的算法，1表示只支持wpa，2表示只支持wep,3表示两者都支持，wep已经被淘汰了，请不要使用。
auth_algs=1

#wpa加密方式，1代表支持wpa,2代表支持wap2,3代表两者都支持。
wpa=2

#wifi密码，请自行修改
wpa_passphrase=1234567890

#对所有用户进行同样的认证，不进行单独的认证，如果需要，请设置为WPA-EAP。
wpa_key_mgmt=WPA-PSK

#控制支持加密数据的秘钥，CCMP比TKIP更强
wpa_pairwise=TKIP
rsn_pairwise=CCMP

$ tftp -r dhcp.conf -g 192.168.26.6
$ cat dhcp.conf 
start 192.168.43.30  # 定义地址池的开始地址
end 192.168.43.100   # 定义地址池的结束地址
interface wlan0      # dhcp服务器中响应dhcp协议的接口
$ tftp -r hostapd.sh -g 192.168.26.6
$ cat hostapd.sh 
#!/bin/sh

# modprobe iwlwifi
modprobe ath10k_pci
# modprobe rtl8192ee
./hostapd -B hostapd.conf
ifconfig wlan0 192.168.43.1 # 必须先设IP，否则udhcpd不工作
udhcpd dhcp.conf
$ chmod +x hostapd.sh
$ ./hosapd.sh
$ iperf3 -c 192.168.43.30
$ iperf3 -s
# 使用802.11n性能获得很大提升，更改channel，看哪个channel不拥挤
root@zynq_cr_pcie:~# iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.30, port 12269
[  5] local 192.168.43.1 port 5201 connected to 192.168.43.30 port 12270
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  10.5 MBytes  88.0 Mbits/sec
[  5]   1.00-2.00   sec  11.1 MBytes  93.1 Mbits/sec
[  5]   2.00-3.00   sec  10.9 MBytes  91.7 Mbits/sec
[  5]   3.00-4.00   sec  11.1 MBytes  93.0 Mbits/sec
[  5]   4.00-5.00   sec  11.3 MBytes  94.7 Mbits/sec
[  5]   5.00-6.00   sec  10.9 MBytes  91.1 Mbits/sec
[  5]   6.00-7.00   sec  11.4 MBytes  95.4 Mbits/sec
[  5]   7.00-8.00   sec  11.5 MBytes  96.4 Mbits/sec
[  5]   8.00-9.00   sec  11.5 MBytes  96.5 Mbits/sec
[  5]   9.00-10.00  sec  11.7 MBytes  97.9 Mbits/sec
[  5]  10.00-10.06  sec   735 KBytes  98.7 Mbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.06  sec   112 MBytes  93.8 Mbits/sec                  receiver
```
测试5G WIFI时，发现petalinux默认编译的hostapd不支持`ieee80211ac=1`，需要打开`CONFIG_IEEE80211AC=y`，
> [Ubuntu14.04系统hostapd编译及使用](https://latelee.blog.csdn.net/article/details/51987397)
> [如何用hostapd配置树莓派wifi的发射功率](https://ask.csdn.net/questions/710467)
> [hostapd配置解析](https://blog.csdn.net/u013316124/article/details/82781339)
> [[N1盒子] 利用hostapd启动802.11ac 5G无线AP wifi热点 二级路由 桥接](https://blog.csdn.net/weixin_30855099/article/details/99439477)
> [hostapd_v4.conf](https://gitee.com/barfoot/hostapd_conf/blob/master/hostapd_v4.conf)
> [从QCA9880谈起，聊聊ath10k和hostapd的一些坑](https://blog.stdio.io/913)
> [Wifi 5GHz AP Mode: What does `no IR` means and can I bypass it?](https://superuser.com/questions/809282/wifi-5ghz-ap-mode-what-does-no-ir-means-and-can-i-bypass-it)
> [Fedora 32/hostapd; WiFi AP 5Ghz Frequencies, no IR issues](https://superuser.com/questions/1565303/fedora-32-hostapd-wifi-ap-5ghz-frequencies-no-ir-issues)
> [openwrt WIFI 不同国家channel list设置](https://blog.csdn.net/linbounconstraint/article/details/80899321)
> [Channel turns from usable to NO-IR in a few hours](https://stackoverflow.com/questions/61566772/channel-turns-from-usable-to-no-ir-in-a-few-hours)
> [[SOLVED] "no IR" on almost all 5Ghz ac channels](https://ask.csdn.net/questions/3471777)
> [hostapd Interface initialization failed in DFS-CAC-START](https://stackoverflow.com/questions/65024736/hostapd-interface-initialization-failed-in-dfs-cac-start)
> [How to configure hostapd for a 5Ghz network](https://raspberrypi.stackexchange.com/questions/91074/how-to-configure-hostapd-for-a-5ghz-network)
> [ath10k driver](https://wireless.wiki.kernel.org/en/users/drivers/ath10k/configuration)
> [Monitor “Dynamic Frequency Selection” (DFS)?](https://unix.stackexchange.com/questions/510509/monitor-dynamic-frequency-selection-dfs)
> [does not work in band 2 as AP #14](https://github.com/astsam/rtl8812au/issues/14)
> [Thread: hostap can't set 5ghz channel](https://ubuntuforums.org/showthread.php?t=2032357)
> [RTL8822BE 5GHz AP mode not supported? #29](https://github.com/lwfinger/rtw88/issues/29)
> [基于Zynq的RT3070 WIFI + hostapd 实现Wifi和WifiAP](https://blog.csdn.net/chuhang_zhqr/article/details/52507185)
> [命令设置wifi国家码](https://blog.csdn.net/h784707460/article/details/79980240)
> [Linux Ubuntu下Atheros 无线网卡 5GHz 工作频段破解](https://blog.csdn.net/bingo1991/article/details/22054441)
> [Linux CRDA(Central Regulatory Domain Agent)](https://blog.csdn.net/hengkong_horse/article/details/8936566)

如果只使能`hw_mode=a`，则信道配置36，44，149均失败，测试`channel=0`，自动选择信道，也失败，所有5G信道均是NO IR，采用`hostapd -d -B hostapd.conf`开启详细打印，本质上是由于设置country code后，但是`Channel list update timeout - try to continue anyway`，导致5G信道均是NO IR。
```bash
$ cat hostapd.conf
interface=wlan0
driver=nl80211
ssid=zynq_cr_pcie
# 5 Ghz
hw_mode=a
ieee80211n=1
ieee80211ac=1
# This enables radar detection and DFS support
ieee80211h=1
# This advertises the country_code
ieee80211d=1
country_code=CN
channel=149
ht_capab=[HT40+]
vht_capab=[SHORT-GI-80]
wpa=2
wpa_passphrase=1234567890
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
$ hostapd -d -B hostapd.conf
# 运行后， iw list有可能显示有可用频段，不是no IR了，
$ iw list
                Frequencies:
                        * 5180 MHz [36] (30.0 dBm)
                        * 5200 MHz [40] (30.0 dBm) (no IR)
                        * 5220 MHz [44] (30.0 dBm)
                        * 5240 MHz [48] (30.0 dBm) (no IR)
                        * 5260 MHz [52] (30.0 dBm) (no IR, radar detection)
                        * 5280 MHz [56] (30.0 dBm) (no IR, radar detection)
                        * 5300 MHz [60] (30.0 dBm) (no IR, radar detection)
                        * 5320 MHz [64] (30.0 dBm) (no IR, radar detection)
                        * 5500 MHz [100] (disabled)
                        * 5520 MHz [104] (disabled)
                        * 5540 MHz [108] (disabled)
                        * 5560 MHz [112] (disabled)
                        * 5580 MHz [116] (disabled)
                        * 5600 MHz [120] (disabled)
                        * 5620 MHz [124] (disabled)
                        * 5640 MHz [128] (disabled)
                        * 5660 MHz [132] (disabled)
                        * 5680 MHz [136] (disabled)
                        * 5700 MHz [140] (disabled)
                        * 5720 MHz [144] (30.0 dBm) (no IR)
                        * 5745 MHz [149] (30.0 dBm) (no IR)
                        * 5765 MHz [153] (30.0 dBm) (no IR)
                        * 5785 MHz [157] (30.0 dBm) (no IR)
                        * 5805 MHz [161] (30.0 dBm)
                        * 5825 MHz [165] (30.0 dBm) (no IR)
                        * 5845 MHz [169] (30.0 dBm) (no IR)
# 运行后， iw list有可能显示有可用频段，不是no IR了，该配置文件无法工作，[从QCA9880谈起，聊聊ath10k和hostapd的一些坑](https://blog.stdio.io/913)
$ cat hostapd.conf 
interface=wlan0
driver=nl80211
hw_mode=a
channel=0
#max_num_sta=255
#Details for Connecting Clients via WPA2 TKIP
ssid=zynq_cr_pcie
auth_algs=1
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP
wpa_passphrase=1234567890
ieee80211d=1
country_code=US #FR可以开启149和161信道，但是还是不能80MHz
ieee80211n=1
ht_capab=[LDPC][HT40+][SHORT-GI-20][SHORT-GI-40][TX-STBC][DSSS_CCK-40]
ieee80211ac=1
vht_capab=[SHORT-GI-80][MAX-MPDU-11454][RXLDPC][TX-STBC-2BY1][MAX-A-MPDU-LEN-EXP3][RX-ANTENNA-PATTERN][TX-ANTENNA-PATTERN]
vht_oper_chwidth=0 #vht_oper_chwidth=1 80MHz初始化失败
beacon_int=100
dtim_period=2
wmm_enabled=1
wmm_ac_bk_cwmin=4
wmm_ac_bk_cwmax=10
wmm_ac_bk_aifs=7
wmm_ac_bk_txop_limit=0
wmm_ac_bk_acm=0
wmm_ac_be_aifs=3
wmm_ac_be_cwmin=4
wmm_ac_be_cwmax=10
wmm_ac_be_txop_limit=0
wmm_ac_be_acm=0
wmm_ac_vi_aifs=2
wmm_ac_vi_cwmin=3
wmm_ac_vi_cwmax=4
wmm_ac_vi_txop_limit=94
wmm_ac_vi_acm=0
wmm_ac_vo_aifs=2
wmm_ac_vo_cwmin=2
wmm_ac_vo_cwmax=3
wmm_ac_vo_txop_limit=47
wmm_ac_vo_acm=0
# 换这个配置文件，ieee80211ac=1，可以工作，但是都是iperf3 server提高到15MB/s，但是iperf3 client速度还是只有4MB/s，[How to configure hostapd for a 5Ghz network](https://raspberrypi.stackexchange.com/questions/91074/how-to-configure-hostapd-for-a-5ghz-network)
$ cat hostapd.conf 
interface=wlan0
ssid=pi-5G
macaddr_acl=0
ignore_broadcast_ssid=0
## 2.4G
#hw_mode=g
#channel=6
## 5G
hw_mode=a
channel=44
#country_code=CN
#ieee80211d=1
ieee80211n=1
ieee80211ac=1
# 下面这两行加上则初始化失败
#ht_capab=[HT40+]
#vht_capab=[SHORT-GI-80]
wmm_enabled=1
## wpa auth
auth_algs=1
wpa=2
wpa_passphrase=11111111
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
# [[N1盒子] 利用hostapd启动802.11ac 5G无线AP wifi热点 二级路由 桥接](https://www.cnblogs.com/wxfy/p/10879858.html)
interface=wlan0
channel=44
driver=nl80211
logger_syslog=0
logger_syslog_level=0
wmm_enabled=1
wpa=2
preamble=1
wpa_psk=66eb31d2b48d19ba216f2e50c6831ee11be98e2fa3a8075e30b866f4a5ccda27
wpa_passphrase=12345678
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
auth_algs=1
macaddr_acl=0
noscan=1
## IEEE 802.11n
ieee80211n=1
ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40]
country_code=CN
ieee80211d=1
## IEEE 802.11a
hw_mode=a
### IEEE 802.11ac
ieee80211ac=1
vht_capab=[MAX-MPDU-3895][SHORT-GI-80]
vht_oper_chwidth=1
vht_oper_centr_freq_seg0_idx=42
basic_rates=60 90 120 180 240 360 480 540
disassoc_low_ack=0
ssid=N1
# controlling enabled
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# 2019.1默认的/etc/network/interfaces大改，开机就是dhcpc，当然也可能是petalinux配置的时候没有选择静态IP，无需手动执行命令
$ udhcpc -i eth0
$ killall hostapd
$ tftp -r hostapd.conf -g 192.168.2.127
$ tftp -r hostapd1.conf -g 192.168.2.127
$ tftp -r dhcp.conf -g 192.168.2.127
$ cd /usr/sbin
$ tftp -r hostapd -g 192.168.2.127
$ tftp -r hostapd_cli -g 192.168.2.127
$ cd
$ hostapd -B hostapd.conf
$ ifconfig wlan0 192.168.43.1 # 必须先设IP，否则udhcpd不工作
$ udhcpd dhcp.conf
$ git diff drivers/net/wireless/ath/Kconfig > ath_kconfig.patch
developer@ubuntu:~/project/xilinx/linux-xlnx$ git diff drivers/net/wireless/ath/regd > ath_kconfig.patch
regd.c         regd_common.h  regd.h         
developer@ubuntu:~/project/xilinx/linux-xlnx$ git diff drivers/net/wireless/ath/regd.c > ath_regd.patch
developer@ubuntu:~/project/xilinx/linux-xlnx$ 
developer@ubuntu:~/project/xilinx/linux-xlnx$ 
developer@ubuntu:~/project/xilinx/linux-xlnx$ cat ath_kconfig.patch 
diff --git a/drivers/net/wireless/ath/Kconfig b/drivers/net/wireless/ath/Kconfig
index 44b2470..2d9031f 100644
--- a/drivers/net/wireless/ath/Kconfig
+++ b/drivers/net/wireless/ath/Kconfig
@@ -22,6 +22,9 @@ config WLAN_VENDOR_ATH
 
 if WLAN_VENDOR_ATH
 
+config ATH_USER_REGD
+	bool "Do not enforce EEPROM regulatory restrictions"
+
 config ATH_DEBUG
 	bool "Atheros wireless debugging"
 	---help---
developer@ubuntu:~/project/xilinx/linux-xlnx$ cat ath_regd.patch 
diff --git a/drivers/net/wireless/ath/regd.c b/drivers/net/wireless/ath/regd.c
index e25bfdf..0b74e0e 100644
--- a/drivers/net/wireless/ath/regd.c
+++ b/drivers/net/wireless/ath/regd.c
@@ -116,6 +116,8 @@ static const struct ieee80211_regdomain ath_world_regdom_67_68_6A_6C = {
 
 static bool dynamic_country_user_possible(struct ath_regulatory *reg)
 {
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return true;
 	if (IS_ENABLED(CONFIG_ATH_REG_DYNAMIC_USER_CERT_TESTING))
 		return true;
 
@@ -188,6 +190,8 @@ static bool dynamic_country_user_possible(struct ath_regulatory *reg)
 
 static bool ath_reg_dyn_country_user_allow(struct ath_regulatory *reg)
 {
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return true;
 	if (!IS_ENABLED(CONFIG_ATH_REG_DYNAMIC_USER_REG_HINTS))
 		return false;
 	if (!dynamic_country_user_possible(reg))
@@ -345,6 +349,9 @@ ath_reg_apply_beaconing_flags(struct wiphy *wiphy,
 	struct ieee80211_channel *ch;
 	unsigned int i;
 
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return;
+
 	for (band = 0; band < NUM_NL80211_BANDS; band++) {
 		if (!wiphy->bands[band])
 			continue;
@@ -378,6 +385,9 @@ ath_reg_apply_ir_flags(struct wiphy *wiphy,
 {
 	struct ieee80211_supported_band *sband;
 
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return;
+
 	sband = wiphy->bands[NL80211_BAND_2GHZ];
 	if (!sband)
 		return;
@@ -407,6 +417,9 @@ static void ath_reg_apply_radar_flags(struct wiphy *wiphy,
 	struct ieee80211_channel *ch;
 	unsigned int i;
 
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return;
+
 	if (!wiphy->bands[NL80211_BAND_5GHZ])
 		return;
 
@@ -639,6 +652,10 @@ ath_regd_init_wiphy(struct ath_regulatory *reg,
 	const struct ieee80211_regdomain *regd;
 
 	wiphy->reg_notifier = reg_notifier;
+
+	if (IS_ENABLED(CONFIG_ATH_USER_REGD))
+		return 0;
+
 	wiphy->regulatory_flags |= REGULATORY_STRICT_REG |
 				   REGULATORY_CUSTOM_REG;

$ cat ~/project/zynq-v2018.2/project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend 
...
# SRC_URI += "file://macb.patch"
SRC_URI += "file://ath_kconfig.patch"
SRC_URI += "file://ath_regd.patch"
...
$ petalinux-config -c kernel
$ petalinux-build
$ petalinux-package --boot --fpga images/linux/system_wrapper.bit --u-boot --force
$ cp -vf images/linux/BOOT.BIN /mnt/hgfs/dog/tftp/ax7350
$ cp -vf images/linux/image.ub /mnt/hgfs/dog/tftp/ax7350
# 关掉下面的配置，竟然发现iw list显示的5G频段信息有变化
[*]     cfg80211 certification onus                              │ │  
  │ │    [*]       cfg80211 regulatory support for cellular base station h│ │  
  │ │    [*]       cfg80211 support for NO_IR relaxation                  │ │ 
                Frequencies:
                        * 5180 MHz [36] (20.0 dBm) (no IR)
                        * 5200 MHz [40] (20.0 dBm) (no IR)
                        * 5220 MHz [44] (20.0 dBm) (no IR)
                        * 5240 MHz [48] (20.0 dBm) (no IR)
                        * 5260 MHz [52] (20.0 dBm) (no IR, radar detection)
                        * 5280 MHz [56] (20.0 dBm) (no IR, radar detection)
                        * 5300 MHz [60] (20.0 dBm) (no IR, radar detection)
                        * 5320 MHz [64] (20.0 dBm) (no IR, radar detection)
                        * 5500 MHz [100] (20.0 dBm) (no IR, radar detection)
                        * 5520 MHz [104] (20.0 dBm) (no IR, radar detection)
                        * 5540 MHz [108] (20.0 dBm) (no IR, radar detection)
                        * 5560 MHz [112] (20.0 dBm) (no IR, radar detection)
                        * 5580 MHz [116] (20.0 dBm) (no IR, radar detection)
                        * 5600 MHz [120] (20.0 dBm) (no IR, radar detection)
                        * 5620 MHz [124] (20.0 dBm) (no IR, radar detection)
                        * 5640 MHz [128] (20.0 dBm) (no IR, radar detection)
                        * 5660 MHz [132] (20.0 dBm) (no IR, radar detection)
                        * 5680 MHz [136] (20.0 dBm) (no IR, radar detection)
                        * 5700 MHz [140] (20.0 dBm) (no IR, radar detection)
                        * 5720 MHz [144] (20.0 dBm) (no IR, radar detection)
                        * 5745 MHz [149] (20.0 dBm) (no IR)
                        * 5765 MHz [153] (20.0 dBm) (no IR)
                        * 5785 MHz [157] (20.0 dBm) (no IR)
                        * 5805 MHz [161] (20.0 dBm) (no IR)
                        * 5825 MHz [165] (20.0 dBm) (no IR)
                        * 5845 MHz [169] (disabled)
# 还是一样的现象，现在估计只能升级内核了，博客里使用的是4.18，搜索查看PetaLinux 2018.2/2018.3/2019.1 - Product Update Release Notes and Known Issues，2018.3的内核还是4.14，2019.1的升级到了4.19，最后一个支持hdf的petalinux，以后的都是xsa格式了。
$ rm -rf zynq-v2019.1
$ petalinux-create -t project -n zynq-v2019.1 --template zynq
$ cp zynq-v2018.2/system_wrapper.hdf zynq-v2019.1/
$ cd zynq-v2019.1
# or
$ petalinux-create -t project -n zynq_cr_pcie_2019_1 --template zynq
$ cd zynq_cr_pcie_2019_1
$ cp ../zynq_cr_pcie/system_wrapper.hdf .
# next
$ petalinux-config --get-hw-description=.
$ petalinux-config -c kernel
CONFIG_CFG80211_REQUIRE_SIGNED_REGDB=y
CONFIG_CFG80211_USE_KERNEL_REGDB_KEYS=y
CONFIG_CFG80211_DEFAULT_PS=y
CONFIG_CFG80211_CRDA_SUPPORT=y
CONFIG_CFG80211_WEXT=y
CONFIG_MAC80211=y
CONFIG_MAC80211_HAS_RC=y
CONFIG_MAC80211_RC_MINSTREL=y
CONFIG_MAC80211_RC_MINSTREL_HT=y
CONFIG_MAC80211_RC_MINSTREL_VHT=y
CONFIG_MAC80211_RC_DEFAULT_MINSTREL=y
CONFIG_MAC80211_RC_DEFAULT="minstrel_ht"
CONFIG_MAC80211_LEDS=y
CONFIG_AT803X_PHY=m
CONFIG_MICREL_PHY=m
CONFIG_ATH10K=m
CONFIG_ATH10K_CE=y
CONFIG_ATH10K_PCI=m
CONFIG_IWLWIFI=m
CONFIG_IWLWIFI_LEDS=y
CONFIG_IWLDVM=m
CONFIG_IWLMVM=m
CONFIG_IWLWIFI_OPMODE_MODULAR=y
CONFIG_RTL8192EE=m
CONFIG_RFKILL=y
CONFIG_RFKILL_LEDS=y
CONFIG_RFKILL_INPUT=y
$ petalinux-create -t apps -n myapp
$ petalinux-create -t apps -n myfw
$ petalinux-create -t apps -n myfw-init
IMAGE_INSTALL_append = " peekpoke"
IMAGE_INSTALL_append = " gpio-demo"
IMAGE_INSTALL_append = " myapp"
IMAGE_INSTALL_append = " myfw"
IMAGE_INSTALL_append = " myfw-init"
IMAGE_INSTALL_append = " iperf3"
IMAGE_INSTALL_append = " wpa-supplicant"
IMAGE_INSTALL_append = " hostapd"
IMAGE_INSTALL_append = " iw"
$ petalinux-config -c rootfs
# 更新设备树
$ petalinux-build
# 2019.2 component不生成fsbl源代码了，目前不知道怎么给fsbl打patch，使用2018.2的fsbl，或者直接用2018.2的boot.bin得了
$ petalinux-package --boot --fpga images/linux/system_wrapper.bit --u-boot --force
$ petalinux-package --prebuilt
$ ls -l pre-built/linux/images/
total 27776
-rw-rw-r-- 1 developer developer  3319436 Apr 18 09:46 BOOT.BIN
-rw-r--r-- 1 developer developer    14635 Apr 18 09:46 system.dtb
-rw-r--r-- 1 developer developer  2120754 Apr 18 09:46 System.map.linux
-rw-r--r-- 1 developer developer   564952 Apr 18 09:46 u-boot.elf
-rw-r--r-- 1 developer developer 21855784 Apr 18 09:46 zImage
-rw-r--r-- 1 developer developer   559688 Apr 18 09:46 zynq_fsbl.elf
$ petalinux-package --bsp -p . --output zynq_cr_pcie_2019_1.bsp
# 2018.2和2019.1的regd补丁文件也一样
# 现象和2018.2一样，[How to configure hostapd for a 5Ghz network](https://raspberrypi.stackexchange.com/questions/91074/how-to-configure-hostapd-for-a-5ghz-network)文章没有实现，但是确实更新内核后，发送速度变快了
```
最终性能接收15MB/s，发送12MB/s。
![62](https://img-blog.csdnimg.cn/20210415032613500.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==,size_16,color_FFFFFF,t_70)
不能80MHz定位了是没有打开`ieee80211h=1`，DFS才能申请到足够的频道，
```bash
nl80211: Failed to start radar detection: -22 (Invalid argument)
DFS start_dfs_cac() failed, -1
Interface initialization failed

hostapd-2.9\src\drivers\driver_nl80211.c <-> linux-xlnx-v2018.2\net\wireless\nl80211.c
nl80211_start_radar_detection            <-> nl80211_start_radar_detection
                                               reg_get_dfs_region

hostapd-2.9\src\drivers\driver_nl80211.c <-> linux-xlnx-v2018.2\net\wireless\nl80211.c
wpa_driver_nl80211_set_country            <-> nl80211_req_set_reg

```
1.单条空间流环境
5G（20/40/80/160MHz）物理层最大速率分别为：87.6/200/433/867Mbps（802.11ac协议下，走802.11n的5G速率和2.4G一样）
2.实际使用时一般只有理论速率的1/2-2/3左右，但即使这样，单条空间流（单天线）下，接入带宽在50兆以下基本没区别，何况P2为2x2MIMO设计（双收发天线，理论速率比单天线翻倍）。
不过为了提高兼容性建议选择自动模式。
3.信道是动态环境，怎么选择因环境而异，很多东西可以多翻翻置顶帖
https://bbs.360.cn/thread-14219235-1-1.html
https://bbs.360.cn/thread-14220954-1-1.html
```bash
ctrl_interface=/var/run/hostapd
interface=wlan0
driver=nl80211
#bridge=br-lan

### IEEE 802.11
ssid=zynq_cr_pcie
hw_mode=a
channel=0
max_num_sta=128
auth_algs=1
disassoc_low_ack=1

### DFS
ieee80211h=1
ieee80211d=1
country_code=FR

### IEEE 802.11n
ieee80211n=1
ht_capab=[HT40+][LDPC][SHORT-GI-20][SHORT-GI-40][TX-STBC][RX-STBC1][DSSS_CCK-40]

### IEEE 802.11ac
ieee80211ac=1
vht_oper_chwidth=1
vht_capab=[MAX-MPDU-11454][RXLDPC][SHORT-GI-80][TX-STBC-2BY1][RX-STBC-1][MAX-A-MPDU-LEN-EXP7][RX-ANTENNA-PATTERN][TX-ANTENNA-PATTERN]

### WPA/IEEE 802.11i
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_passphrase=1234567890
wpa_pairwise=CCMP

### Wi-Fi Protected Setup (WPS)
wps_state=2
ap_setup_locked=0
wps_pin_requests=/var/run/hostapd_wps_pin_requests
device_name=QCA Access Point
manufacturer=Qualcomm Atheros
device_type=6-0050F204-1
config_methods=virtual_push_button physical_push_button label keypad virtual_display
pbc_in_m1=1
ap_pin=12345670
upnp_iface=br-lan
eap_server=1

### hostapd event logger configuration
logger_syslog=127
logger_syslog_level=2
logger_stdout=127
logger_stdout_level=2

### WMM
wmm_enabled=1
uapsd_advertisement_enabled=1
wmm_ac_bk_cwmin=4
wmm_ac_bk_cwmax=10
wmm_ac_bk_aifs=7
wmm_ac_bk_txop_limit=0
wmm_ac_bk_acm=0
wmm_ac_be_aifs=3
wmm_ac_be_cwmin=4
wmm_ac_be_cwmax=10
wmm_ac_be_txop_limit=0
wmm_ac_be_acm=0
wmm_ac_vi_aifs=2
wmm_ac_vi_cwmin=3
wmm_ac_vi_cwmax=4
wmm_ac_vi_txop_limit=94
wmm_ac_vi_acm=0
wmm_ac_vo_aifs=2
wmm_ac_vo_cwmin=2
wmm_ac_vo_cwmax=3
wmm_ac_vo_txop_limit=47
wmm_ac_vo_acm=0

### TX queue parameters
tx_queue_data3_aifs=7
tx_queue_data3_cwmin=15
tx_queue_data3_cwmax=1023
tx_queue_data3_burst=0
tx_queue_data2_aifs=3
tx_queue_data2_cwmin=15
tx_queue_data2_cwmax=63
tx_queue_data2_burst=0
tx_queue_data1_aifs=1
tx_queue_data1_cwmin=7
tx_queue_data1_cwmax=15
tx_queue_data1_burst=3.0
tx_queue_data0_aifs=1
tx_queue_data0_cwmin=3
tx_queue_data0_cwmax=7
tx_queue_data0_burst=1.5
```
hostapd执行不要加-B，否则很多打印消息没打出来，hostapd就退出程序了，注意参数`vht_oper_chwidth=1`，不知道为什么ACS发现不支持80MHz，改为0后可以初始化成功，
```c
ACS: Survey analysis for selected bandwidth 80 MHz
ACS: Channel 36: not enough bandwidth
ACS: Channel 40: not allowed as primary channel for HT40
ACS: Channel 44: not allowed as primary channel for VHT80
ACS: Channel 149: not enough bandwidth
ACS: Channel 161: not allowed as primary channel for HT40
ACS: Failed to compute ideal channel
Interface initialization failed

# 0 = 20 or 40 MHz operating Channel width
# 1 = 80 MHz channel width
# 2 = 160 MHz channel width
# 3 = 80+80 MHz channel width
#vht_oper_chwidth=1

root@zynq-v2019:~# iperf3 -c 192.168.43.30
Connecting to host 192.168.43.30, port 5201
[  5] local 192.168.43.1 port 53816 connected to 192.168.43.30 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  22.3 MBytes   187 Mbits/sec    0    421 KBytes       
[  5]   1.00-2.00   sec  27.2 MBytes   228 Mbits/sec    0    444 KBytes       
[  5]   2.00-3.00   sec  25.7 MBytes   216 Mbits/sec    0    465 KBytes       
[  5]   3.00-4.00   sec  27.6 MBytes   231 Mbits/sec    0    465 KBytes       
[  5]   4.00-5.00   sec  27.2 MBytes   229 Mbits/sec    0    495 KBytes       
[  5]   5.00-6.00   sec  27.2 MBytes   228 Mbits/sec    0    495 KBytes       
[  5]   6.00-7.00   sec  26.9 MBytes   226 Mbits/sec    0    495 KBytes       
[  5]   7.00-8.00   sec  26.8 MBytes   225 Mbits/sec    0    495 KBytes       
[  5]   8.00-9.00   sec  25.1 MBytes   211 Mbits/sec    0    547 KBytes       
[  5]   9.00-10.00  sec  27.2 MBytes   228 Mbits/sec    0    583 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   263 MBytes   221 Mbits/sec    0             sender
[  5]   0.00-10.00  sec   262 MBytes   220 Mbits/sec                  receiver

iperf Done.
root@zynq-v2019:~# iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.30, port 42696
[  5] local 192.168.43.1 port 5201 connected to 192.168.43.30 port 42698
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  36.1 MBytes   303 Mbits/sec                  
[  5]   1.00-2.00   sec  38.0 MBytes   319 Mbits/sec                  
[  5]   2.00-3.00   sec  38.9 MBytes   326 Mbits/sec                  
[  5]   3.00-4.00   sec  36.8 MBytes   309 Mbits/sec                  
[  5]   4.00-5.00   sec  37.2 MBytes   312 Mbits/sec                  
[  5]   5.00-5.03   sec  1.30 MBytes   332 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-5.03   sec   188 MBytes   314 Mbits/sec                  receiver
```
不能80MHz的问题，定位了是因为配置文件没有打开`ieee80211h=1`，开启DFS才能申请到足够的频道，但是又报新问题，
```bash
nl80211: Failed to start radar detection: -22 (Invalid argument)
DFS start_dfs_cac() failed, -1
Interface initialization failed
```
DFS不支持，发现是内核相应配置项没有打开，启用DFS，内核其实无需打补丁，必须设置国家码为CN，否则小米手机搜索不到，
```bash
CONFIG_CFG80211_CERTIFICATION_ONUS=y
CONFIG_CFG80211_EXTRA_REGDB_KEYDIR=""
# CONFIG_CFG80211_REG_CELLULAR_HINTS is not set
# CONFIG_CFG80211_REG_RELAX_NO_IR is not set
# CONFIG_ATH_USER_REGD is not set
# CONFIG_ATH_REG_DYNAMIC_USER_REG_HINTS is not set
CONFIG_ATH10K_DFS_CERTIFIED=y
```
最终配置文件，
```bash
interface=wlan0
driver=nl80211
hw_mode=a
channel=0
ssid=zynq_cr_pcie
auth_algs=1
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP
wpa_passphrase=1234567890
ieee80211h=1
ieee80211d=1
country_code=CN
ieee80211n=1
ht_capab=[LDPC][HT40+][SHORT-GI-20][SHORT-GI-40][TX-STBC][DSSS_CCK-40]
ieee80211ac=1
vht_capab=[SHORT-GI-80][MAX-MPDU-11454][RXLDPC][TX-STBC-2BY1][MAX-A-MPDU-LEN-EXP3][RX-ANTENNA-PATTERN][TX-ANTENNA-PATTERN]
vht_oper_chwidth=1
beacon_int=100
dtim_period=2
wmm_enabled=1
wmm_ac_bk_cwmin=4
wmm_ac_bk_cwmax=10
wmm_ac_bk_aifs=7
wmm_ac_bk_txop_limit=0
wmm_ac_bk_acm=0
wmm_ac_be_aifs=3
wmm_ac_be_cwmin=4
wmm_ac_be_cwmax=10
wmm_ac_be_txop_limit=0
wmm_ac_be_acm=0
wmm_ac_vi_aifs=2
wmm_ac_vi_cwmin=3
wmm_ac_vi_cwmax=4
wmm_ac_vi_txop_limit=94
wmm_ac_vi_acm=0
wmm_ac_vo_aifs=2
wmm_ac_vo_cwmin=2
wmm_ac_vo_cwmax=3
wmm_ac_vo_txop_limit=47
wmm_ac_vo_acm=0
```
配置脚本，
```bash
#!/bin/sh

ifconfig wlan0 192.168.43.1
udhcpd /etc/dhcpd.conf
myapp.elf &
#hostapd -d /etc/hostapd.conf -f /home/root/hostapd.log
hostapd /etc/hostapd.conf
```
速度，使用手机iperf3测速，测试手机红米K30 Pro，骁龙865 SOC，
```bash
root@zynq-v2019:~# iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.30, port 46802
[  5] local 192.168.43.1 port 5201 connected to 192.168.43.30 port 46804
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  49.0 MBytes   411 Mbits/sec                  
[  5]   1.00-2.00   sec  58.1 MBytes   487 Mbits/sec                  
[  5]   2.00-3.00   sec  57.1 MBytes   479 Mbits/sec                  
[  5]   3.00-4.00   sec  57.1 MBytes   479 Mbits/sec                  
[  5]   4.00-5.00   sec  57.1 MBytes   479 Mbits/sec                  
[  5]   5.00-5.06   sec  3.22 MBytes   492 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-5.06   sec   282 MBytes   467 Mbits/sec                  receiver
root@zynq-v2019:~# iperf3 -c 192.168.43.30
Connecting to host 192.168.43.30, port 5201
[  5] local 192.168.43.1 port 56530 connected to 192.168.43.30 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  27.8 MBytes   233 Mbits/sec    0    532 KBytes       
[  5]   1.00-2.00   sec  31.8 MBytes   267 Mbits/sec    0    638 KBytes       
[  5]   2.00-3.00   sec  33.2 MBytes   278 Mbits/sec    0    675 KBytes       
[  5]   3.00-4.00   sec  30.5 MBytes   256 Mbits/sec    0    675 KBytes       
[  5]   4.00-5.00   sec  29.7 MBytes   249 Mbits/sec    0    675 KBytes       
[  5]   5.00-6.00   sec  31.7 MBytes   266 Mbits/sec    0    711 KBytes       
[  5]   6.00-7.00   sec  30.0 MBytes   251 Mbits/sec    0    711 KBytes       
[  5]   7.00-8.00   sec  30.3 MBytes   254 Mbits/sec    0    711 KBytes       
[  5]   8.00-9.00   sec  31.7 MBytes   265 Mbits/sec    0    711 KBytes       
[  5]   9.00-10.00  sec  30.3 MBytes   255 Mbits/sec    0    711 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   307 MBytes   257 Mbits/sec    0             sender
[  5]   0.00-10.00  sec   306 MBytes   256 Mbits/sec                  receiver

iperf Done.
```
添加博通驱动，放弃该方法，
```bash
$ petalinux-create -t modules --name broadcom-wl --enable
$ ls -l project-spec/meta-user/recipes-modules/broadcom-wl/
total 12
-rw-rw-r-- 1 developer developer  476 May 29 02:07 broadcom-wl.bb
drwxr-xr-x 2 developer developer 4096 May 29 02:07 files
-rw-rw-r-- 1 developer developer 2582 May 29 02:07 README
```
采用sparklan提供的驱动，
```bash
$ git status
On branch xlnx_rebase_v4.19
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   drivers/net/wireless/Kconfig
	modified:   drivers/net/wireless/Makefile
	modified:   drivers/net/wireless/ath/Kconfig
	modified:   drivers/net/wireless/ath/regd.c

Untracked files:
  (use "git add <file>..." to include in what will be committed)

	drivers/net/wireless/bcmdhd/

no changes added to commit (use "git add" and/or "git commit -a")
$ git add drivers/net/wireless/*
$ git commit -m "add bcmdhd module"
$ git log
commit f8aef3920bdfc4d1531ca01ec8ea11b33debfb8d
Author: Mr.bangbangbabe <qingermaker@sina.com>
Date:   Sat May 29 07:17:58 2021 -0700

    add bcmdhd module

commit 9811303824b66a8db9a8ec61b570879336a9fde5
Author: Harini Katakam <harini.katakam@xilinx.com>
Date:   Tue May 7 19:37:24 2019 +0530

    net: macb: Change interrupt and napi enable order in open
    
    Current order in open:
    -> Enable interrupts (macb_init_hw)
    -> Enable NAPI
    -> Start PHY
    
    Sequence of RX handling:
    -> RX interrupt occurs
    -> Interrupt is cleared and interrupt bits disabled in handler
    -> NAPI is scheduled
    -> In NAPI, RX budget is processed and RX interrupts are re-enabled
    
    With the above, on QEMU or fixed link setups (where PHY state doesn't
    matter), there's a chance macb RX interrupt occurs before NAPI is
    enabled. This will result in NAPI being scheduled before it is enabled.
    Fix this macb open by changing the order.
    
    Signed-off-by: Harini Katakam <harini.katakam@xilinx.com>
    Reviewed-by: Radhey Shyam Pandey <radhey.shyam.pandey@xilinx.com>
    Signed-off-by: Michal Simek <michal.simek@xilinx.com>
$ git format-patch 9811303824b66a8db9a8ec61b570879336a9fde5
0001-add-bcmdhd-module.patch
$ cp ~/project/xilinx/linux-xlnx/0001-add-bcmdhd-module.patch ~/project/zynq-v2019.1/project-spec/meta-user/recipes-kernel/linux/linux-xlnx/
$ cat project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend 
SRC_URI += "file://user_2021-04-14-11-01-00.cfg \
            file://user_2021-04-14-11-52-00.cfg \
            file://user_2021-04-14-12-45-00.cfg \
            file://user_2021-04-20-09-07-00.cfg \
            file://user_2021-05-29-06-37-00.cfg \
            "


#SRC_URI += "file://ath_kconfig.patch"
#SRC_URI += "file://ath_regd.patch"
SRC_URI += "file://0001-add-bcmdhd-module.patch"

FILESEXTRAPATHS_prepend := "${THISDIR}/${PN}:"
# 加载固件
$ cp -v /mnt/hgfs/dog/program/AP6275/FW_AP6275P/* project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/BCM4362A2_001.003.006.0010.0010.btp' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/BCM4362A2_001.003.006.0010.0010.btp'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/BCM4362A2_001.003.006.0016.0018_sLNA_iLNA_CL1.hcd' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/BCM4362A2_001.003.006.0016.0018_sLNA_iLNA_CL1.hcd'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/clm_bcm43752a2_pcie_ag.blob' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/clm_bcm43752a2_pcie_ag.blob'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/fw_bcm43752a2_pcie_ag_apsta.bin' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/fw_bcm43752a2_pcie_ag_apsta.bin'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/fw_bcm43752a2_pcie_ag.bin' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/fw_bcm43752a2_pcie_ag.bin'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/nvram_ap6275p_m2.txt' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/nvram_ap6275p_m2.txt'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/nvram_ap6275p.txt' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/nvram_ap6275p.txt'
'/mnt/hgfs/dog/program/AP6275/FW_AP6275P/ReadMe.txt' -> 'project-spec/meta-user/recipes-apps/myfw/files/bcmdhd/ReadMe.txt'
# 配置内核
fw_bcm43752a2_pcie_ag.bin # Station Mode，参考WiFi User Guide for Linux_v17.pdf
fw_bcm43752a2_pcie_ag_apsta.bin # SoftAP Mode，参考WiFi User Guide for Linux_v17.pdf
<M>   Broadcom FullMAC wireless cards support                    │ │  
  │ │    (/lib/firmware/bcmdhd/fw_bcm43752a2_pcie_ag_apsta.bin) Firmware p│ │  
  │ │    (/lib/firmware/bcmdhd/nvram_ap6275p.txt) NVRAM path              │ │  
  │ │     Enable Chip Interface (PCIe bus interface support)  --->)  ---> │ │  
[ ]   Broadcom devices
```
内核体积变大，改一下flash空间分配，
```bash
Zynq> setenv bootsize 7e0000  
Zynq> setenv bootenvstart 0x7e0000
Zynq> setenv kernelstart 0x800000
Zynq> setenv kernelsize 1800000
```
目前只能工作在2.4g模式，
```bash
root@zynq-v2019:~# cat /etc/hostapd.conf 
interface=wlan0
driver=nl80211
ctrl_interface=/var/run/hostapd
ssid=zynq_cr_pcie
channel=6
ieee80211n=1
hw_mode=g
ignore_broadcast_ssid=0
wpa=2
rsn_pairwise=CCMP
wpa_passphrase=1234567890
root@zynq-v2019:~# iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.30, port 43592
[  5] local 192.168.43.1 port 5201 connected to 192.168.43.30 port 43594
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  9.39 MBytes  78.7 Mbits/sec                  
[  5]   1.00-2.00   sec  11.3 MBytes  94.5 Mbits/sec                  
[  5]   2.00-3.00   sec  13.4 MBytes   113 Mbits/sec                  
[  5]   3.00-4.00   sec  14.5 MBytes   122 Mbits/sec                  
[  5]   4.00-5.00   sec  14.2 MBytes   119 Mbits/sec                  
[  5]   5.00-5.12   sec  1.54 MBytes   109 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-5.12   sec  64.3 MBytes   105 Mbits/sec                  receiver
root@zynq-v2019:~# iperf3 -c 192.168.43.30
Connecting to host 192.168.43.30, port 5201
[  5] local 192.168.43.1 port 42240 connected to 192.168.43.30 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  9.02 MBytes  75.6 Mbits/sec    0    486 KBytes       
[  5]   1.00-2.00   sec  13.6 MBytes   114 Mbits/sec   33    706 KBytes       
[  5]   2.00-3.00   sec  10.4 MBytes  87.4 Mbits/sec    0    803 KBytes       
[  5]   3.00-4.00   sec  15.2 MBytes   127 Mbits/sec    0    875 KBytes       
[  5]   4.00-5.00   sec  16.2 MBytes   136 Mbits/sec    0    928 KBytes       
[  5]   5.00-6.00   sec  15.3 MBytes   129 Mbits/sec    0    962 KBytes       
[  5]   6.00-7.00   sec  14.1 MBytes   118 Mbits/sec    2    700 KBytes       
[  5]   7.00-8.00   sec  16.3 MBytes   137 Mbits/sec    0    754 KBytes       
[  5]   8.00-9.00   sec  18.8 MBytes   158 Mbits/sec    0    792 KBytes       
[  5]   9.00-10.00  sec  16.8 MBytes   141 Mbits/sec    0    814 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   146 MBytes   122 Mbits/sec   35             sender
[  5]   0.00-10.00  sec   144 MBytes   121 Mbits/sec                  receiver

iperf Done.
```
5G问题，参考[hostapd、/dev/random、/dev/urandom](https://www.cnblogs.com/mingyunrangwozoudaoxianzai/p/10106714.html)
```bash
# cat /etc/hostapd.conf 
interface=wlan0
driver=nl80211
ssid=zynq_cr_pcie
# 5 Ghz
hw_mode=a
ieee80211n=1
ieee80211ac=1
# This enables radar detection and DFS support
ieee80211h=1
# This advertises the country_code
ieee80211d=1
country_code=CN
channel=44
#wpa=2
#wpa_passphrase=1234567890
#wpa_key_mgmt=WPA-PSK
#rsn_pairwise=CCMP
# dmesg -c
[dhd-wlan0] wl_cfg80211_add_del_bss : wl bss 2 bssidx:0
[dhd-wlan0] wl_cfg80211_del_station : Disconnect STA : ff:ff:ff:ff:ff:ff scb_val.val 3
[dhd-wlan0] wl_cfg80211_set_channel : netdev_ifidx(4), chan_type(1) target channel(44) 
[dhd] CFG80211-ERROR) wl_cfg80211_parse_ies : No WPSIE in beacon 
[dhd] CFG80211-ERROR) wl_cfg80211_parse_ies : No WPSIE in beacon 
[dhd-wlan0] wl_cfg80211_add_del_bss : wl bss 2 bssidx:0
[dhd-wlan0] wl_cfg80211_bcn_bringup_ap : Creating AP with sec=open/mfpn/none
[dhd] CFG80211-ERROR) wl_cfg80211_bcn_bringup_ap : SoftAP/GO set ssid failed! 
[dhd] CFG80211-ERROR) wl_cfg80211_start_ap : Beacon bring up AP/GO failed 
[dhd] CFG80211-ERROR) wl_cfg80211_start_ap : ADD/SET beacon failed
[dhd-wlan0] wl_cfg80211_del_station : Disconnect STA : ff:ff:ff:ff:ff:ff scb_val.val 3
[dhd-wlan0] wl_cfg80211_del_station : Disconnect STA : ff:ff:ff:ff:ff:ff scb_val.val 3
[dhd-wlan0] wl_cfg80211_add_del_bss : wl bss 3 bssidx:0
```
收到SparkLAN给的一个WIFI6的说明，需要修改nvram的country code，不能设密码，然后，这里注意我的板卡的udhcp可能需要重启，当时手机开了热点，小米手机刚好也是192.168.43.x网段，和我板卡的重复了，板卡和手机导致ping不通，把手机热点关掉即可。
```bash
# vi /lib/firmware/bcmdhd/config.txt
ccode=CN
regrev=0
# rmmod bcmdhd #需要重启驱动
# modprobe bcmdhd #需要重启驱动
# vi /etc/hostapd.conf 
interface=wlan0
driver=nl80211
ssid=zynq_cr_pcie
hw_mode=a
ieee80211ax=1
country_code=CN
channel=36
#wpa=2
#wpa_passphrase=1234567890
#wpa_key_mgmt=WPA-PSK
#rsn_pairwise=CCMP
# ifconfig wlan0 192.168.43.1 #这里不知道为什么wlan0 IP丢了，可能是卸载重装驱动导致的
# killall udhcpd # 有可能需要执行
# udhcpd /etc/dhcpd.conf # 有可能需要执行
# iperf3 -s              
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.43.30, port 47634
[  5] local 192.168.43.1 port 5201 connected to 192.168.43.30 port 47636
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  40.0 MBytes   336 Mbits/sec                  
[  5]   1.00-2.00   sec  31.6 MBytes   265 Mbits/sec                  
[  5]   2.00-3.01   sec  39.8 MBytes   332 Mbits/sec                  
[  5]   3.01-4.00   sec  43.9 MBytes   370 Mbits/sec                  
[  5]   4.00-5.00   sec  41.3 MBytes   346 Mbits/sec                  
[  5]   5.00-5.05   sec  1.46 MBytes   237 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-5.05   sec   198 MBytes   329 Mbits/sec                  receiver
# iperf3 -c 192.168.43.30
Connecting to host 192.168.43.30, port 5201
[  5] local 192.168.43.1 port 56248 connected to 192.168.43.30 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.02   sec  17.9 MBytes   147 Mbits/sec    0    703 KBytes       
[  5]   1.02-2.00   sec  17.1 MBytes   146 Mbits/sec    0   1.18 MBytes       
[  5]   2.00-3.01   sec  42.5 MBytes   354 Mbits/sec    0   1.18 MBytes       
[  5]   3.01-4.01   sec  42.5 MBytes   355 Mbits/sec    0   1.28 MBytes       
[  5]   4.01-5.02   sec  42.5 MBytes   354 Mbits/sec    0   1.28 MBytes       
[  5]   5.02-6.03   sec  42.5 MBytes   353 Mbits/sec    0   1.28 MBytes       
[  5]   6.03-7.00   sec  41.2 MBytes   355 Mbits/sec    0   1.48 MBytes       
[  5]   7.00-8.01   sec  42.5 MBytes   355 Mbits/sec    0   1.48 MBytes       
[  5]   8.01-9.02   sec  42.5 MBytes   353 Mbits/sec    0   1.48 MBytes       
[  5]   9.02-10.03  sec  42.5 MBytes   355 Mbits/sec    0   1.64 MBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.03  sec   374 MBytes   313 Mbits/sec    0             sender
[  5]   0.00-10.03  sec   374 MBytes   313 Mbits/sec                  receiver

iperf Done.
```

# m1117a
```bash
$ cd /lib/modules/3.19.0-fdk-1.0.4-20201026.1453/fdk && tftp -r pcie_chipset.ko -g 192.168.26.6 && sync && cd
$ cd /lib/modules/3.19.0-fdk-1.0.3-20200422.1122/fdk && tftp -r pcie_chipset.ko -g 192.168.26.6 && sync && cd
$ cd /bin && tftp -r blk_benchmark -g 192.168.26.6 && sync && cd
$ cd /bin && tftp -r jjraid_benchmark -g 192.168.26.6 && sync && cd
# 测试pcie_chipset jjraid驱动
$ modprobe pcie_chipset pcie_chipset_vid=0x0731 pcie_chipset_did=0x7014 ucode_addr=-1
$ blk_benchmark -r /dev/jjraid3@a0040000s0 -s 0x0 -l 0x400000 -n 64 # 64.43MB/s
$ blk_benchmark -w /dev/jjraid3@a0040000s0 -s 0x0 -l 0x400000 -n 64 # 117.38MB/s
$ blk_benchmark -r -w /dev/jjraid3@a0040000s0 -s 0x0 -l 0x400000 -n 64 -t 0
$ jjraid_benchmark -r /dev/jjraid3@a0040000s0 -p cmem -s 0x0 -l 0x400000 -n 512 # 183.92MB/s
$ jjraid_benchmark -w /dev/jjraid3@a0040000s0 -p cmem -s 0x0 -l 0x400000 -n 64 # 164.00MB/s
$ jjraid_benchmark -r -w /dev/jjraid3@a0040000s0 -p cmem -s 0x0 -l 0x400000 -n 64 -t 0
$ jjraid_benchmark -r /dev/jjraid3@a0040000s0 -p malloc -s 0x0 -l 0x400000 -n 64 # 61.03MB/s
$ jjraid_benchmark -w /dev/jjraid3@a0040000s0 -p malloc -s 0x0 -l 0x400000 -n 64 # 86.60MB/s
$ jjraid_benchmark -r -w /dev/jjraid3@a0040000s0 -p malloc -s 0x0 -l 0x400000 -n 64 -t 0
$ jjraid_benchmark -r /dev/jjraid3@a0040000s0 -p 0x100000000 -s 0x0 -l 0x400000 -n 64 # 523.52MB/s
$ jjraid_benchmark -w /dev/jjraid3@a0040000s0 -p 0x100000000 -s 0x0 -l 0x400000 -n 64 # 400.63MB/s
# enable merge sgl
$ blk_benchmark -r /dev/jjraid3@a0040000s0 -s 0x0 -l 0x80000 -n 64 # 113.48MB/s
$ blk_benchmark -w /dev/jjraid3@a0040000s0 -s 0x0 -l 0x80000 -n 64 # 120.30MB/s

$ ./develop.sh -t zynq -b package quickboot && cp /home/qe/program/fdk/bsp/zynq/package-v2015.2.1/app/bin/quickboot /mnt/hgfs/dog/tftp/m1117a
$ cd /bin && tftp -r quickboot -g 192.168.26.6 && sync && cd
$ quickboot -w /dev/mtd0 -i M1117V2_U2_V1.bin -s 0
```

# mwm1136


# mwm178
```bash
$ fdk -b dtb && fdk -b uboot && fdk -k boot mini && cp image/boot.bin /mnt/hgfs/dog/tftp/mwt3151/boot_pcie.bin && cp image/system.dtb /mnt/hgfs/dog/tftp/mwt3151/system_pcie.dtb

ZynqMP> setenv ipaddr 192.168.26.17
ZynqMP> setenv serverip 192.168.26.6
ZynqMP> setenv gatewayip 192.168.26.254
ZynqMP> setenv fpga_img MWM178_V1_U6_V1.bit
ZynqMP> run ext4_bringup
```

# mwt3151
```bash
ZynqMP> gpio clear 65
ZynqMP> setenv dtb_img system_pcie.dtb
ZynqMP> setenv dtb_img system_no_pl_pcie.dtb
ZynqMP> setenv boot_img boot_pcie.bin
ZynqMP> setenv fsbl_img zynqmp_fsbl_pcie.elf
ZynqMP> setenv fpga_img MWT3151_V1_U13_V1_PCIe.bit
ZynqMP> setenv serverip 192.168.26.6
ZynqMP> setenv ipaddr 192.168.26.24
ZynqMP> run ext4_bringup
ZynqMP> sf protect unlock 0 0x200000 # 没作用

# 禁止看门狗
$ echo $(expr 65 + 338) > /sys/class/gpio/export
$ echo 403 > /sys/class/gpio/export      
$ echo out > /sys/class/gpio/gpio403/direction 
$ echo 0 > /sys/class/gpio/gpio403/value  
$ flash_unlock /dev/mtd0 0 14 # size=0x1c0000 erasesize=0x2000
```

# mwm190-p3
```bash
# 加载V7驱动
$ modprobe pcie_chipset pcie_chipset_vid=0x0731 pcie_chipset_did=0x2018 ucode_addr=-3
$ cd /boot && tftp -r system.dtb -g 192.168.26.6 && sync && cd

# zu上的axi qspi ip时钟，是pl_clk0通过一个clk_wiz输出一个100M+50M，后改为pl_clk0+pl_clk1就没问题了
$ mtd_debug read /dev/mtd0 0 0x100000 a.bin
Copied 1048576 bytes from address 0x00000000 in flash to a.bin
# 由于调axi qspi ip时候，在qspi设备树里引用了pl_clk，而zu会自动suspend，qspi suspend的时候会把时钟关掉，导致开机后所有ip都无法工作，但是开机时都能识别到，下面两行去掉就可以了。
&axi_quad_spi_0 {
	//clock-names = "axi_clk", "spi_clk";
	//clocks = <&clk 71>, <&clk 72>;
};
```

# mwm196v2
```bash
$ cd ~/nvmelite && ./build.sh -b ft1500a && sudo cp nvme.ko /lib/modules/4.4.131-20200604.kylin.desktop.android-generic/kernel/drivers/nvme/host/nvme.ko && sudo depmod && sudo update-initramfs -u
$ cd ~/chipset && ./build.sh -b ft1500a && sudo cp pcie_chipset.ko /lib/modules/4.4.131-20200604.kylin.desktop.android-generic/fdk && sudo depmod
$ cat test_rd_cpu.sh 
#!/bin/sh

sudo ./nvmel_benchmark -r /dev/nvme0n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme1n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme2n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme3n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme4n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme5n1 -p malloc -s 0 -l auto -n 65536 -m 4
$ cat test_wr_cpu.sh 
#!/bin/sh

sudo ./nvmel_benchmark -w /dev/nvme0n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme1n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme2n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme3n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme4n1 -p malloc -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme5n1 -p malloc -s 0 -l auto -n 65536 -m 4
$ cat test_rd_fpga.sh 
#!/bin/sh

sudo ./nvmel_benchmark -r /dev/nvme0n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme1n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme2n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme3n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme4n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -r /dev/nvme5n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4
$ cat test_wr_fpga.sh 
#!/bin/sh

sudo ./nvmel_benchmark -w /dev/nvme0n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme1n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme2n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme3n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme4n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4 &
sudo ./nvmel_benchmark -w /dev/nvme5n1 -p 0x58000000 -s 0 -l auto -n 65536 -m 4
$ sudo ./dma_benchmark -i xaxicdma -c h2c -s cmem -d 0x500000000 -m cdev:xaxicdma4@5c700000 -l 0x400000 -n 64
$ sudo ./dma_benchmark -i xaxicdma -c c2h -s cmem -d 0x500000000 -m cdev:xaxicdma4@5c700000 -l 0x400000 -n 64
$ PlxEep -l a.bin -d 1 -w 2 # 写eeprom，该命令可以自动更新CRC，需要配置文件的第二个byte为0x80

Selected: 8764 10b5 [04:00.0]

Set address width..... Ok (2-byte)
Load EEPROM file... Ok (10B)
Program EEPROM..... Ok 
Update CRC......... *DISABLED*
 -- Complete (0.01 sec) --

$ PlxEep -s a.bin -d 1 -w 2 # 读eeprom

Selected: 8764 10b5 [04:00.0]

Set address width..... Ok (2-byte)
Get EEPROM data size.. Ok (10B)
Read EEPROM data...... Ok
Write data to file.... Ok (a.bin)
 -- Complete (0.00 sec) --

$ hexdump -C a.bin 
00000000  5a 00 06 00 88 40 00 71  1f 40                    |Z....@.q.@|
```
EEPROM的地址，这个地方没讲清楚，
![347](https://img-blog.csdnimg.cn/20201123102527463.png#pic_center)
得对着Table 6-2来看，`[15:10]`的地址也分了**两**部分，**3位**`Station Number`和**3位**`Relative Port Number`。
![348](https://img-blog.csdnimg.cn/2020112310324862.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1podV9aaHVfMjAwOQ==,size_16,color_FFFFFF,t_70#pic_center)
![349](https://img-blog.csdnimg.cn/20201123103309719.png#pic_center)



